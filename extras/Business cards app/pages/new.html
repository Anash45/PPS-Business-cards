<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Neue Karte ‚Äì PPS Business Cards</title>
  <meta name="description" content="Neue digitale Visitenkarte erstellen" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='16' fill='%23000'/%3E%3Cpath d='M9 16a7 7 0 1114 0 7 7 0 01-14 0zm7-5a5 5 0 100 10 5 5 0 000-10z' fill='%23fff'/%3E%3C/svg%3E" />
  <style>
    :root{
      --bg:#f7f7f8;--bg-elevated:#fff;--card:#fff;--text:#0b0b0c;--muted:#6b7280;--border:#e5e7eb;--accent:#16A34A;--accent-weak:#e7f7ec;--shadow:0 1px 2px rgba(16,24,40,.06),0 1px 3px rgba(16,24,40,.04);--radius:16px
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:var(--bg);color:var(--text);line-height:1.45}
    a{text-decoration:none;color:inherit}

    .app{display:grid;grid-template-columns:280px 1fr;min-height:100dvh}
    .sidebar{position:sticky;top:0;height:100dvh;border-right:1px solid var(--border);background:linear-gradient(180deg,var(--bg-elevated),var(--bg));padding:20px 16px}
    .brand{display:flex;gap:12px;align-items:center;padding:6px 8px}
    .brand-logo{width:32px;height:32px;border-radius:999px;background:#111;color:#fff;display:grid;place-items:center;font-weight:700;font-size:13px}
    .brand-name{font-weight:700}
    .nav{margin-top:18px;display:grid;gap:4px}
    .nav h4{margin:18px 8px 6px;font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .nav a{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:12px;border:1px solid transparent}
    .nav a:hover{background:var(--accent-weak);border-color:var(--border)}
    .nav a.active{background:var(--card);border-color:var(--border);box-shadow:var(--shadow)}

    .header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:linear-gradient(180deg,var(--bg-elevated),rgba(255,255,255,0));border-bottom:1px solid var(--border)}
    .header h1{margin:0;font-size:18px}
    .avatar{width:32px;height:32px;border-radius:999px;background:var(--border);display:grid;place-items:center;font-weight:700}

    .content{padding:20px;display:grid;gap:18px}
    .grid12{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .panel-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .panel-body{padding:16px}

    .segment{display:inline-flex;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:var(--card);box-shadow:var(--shadow)}
    .segment a{padding:8px 12px;font-weight:600}
    .segment a.active{background:var(--bg-elevated)}

    /* Controls */
    .field{display:flex;flex-direction:column;gap:6px}
    .field input[type=color],.field input[type=text],.field input[type=url],.field input[type=email],.field input[type=tel],.field input[type=file],.field select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--bg-elevated);outline:none}
    label{font-weight:600;font-size:13px}
    .subhead{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted)}
    .note{color:var(--muted);font-size:12px}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--card);box-shadow:var(--shadow);font-weight:600;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
    .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
    .btn.inline{padding:8px 10px;font-size:13px}

    /* Mobile-realistische Preview-Breite (read-only Branding) */
    #previewRoot{--tpl-bg:#fff;--tpl-name:#0b0b0c;--tpl-role:#6b7280;--tpl-cta-bg:#F7F7F8;--tpl-cta-text:#0b0b0c;--tpl-sec-bg:#f3f4f6;--tpl-sec-text:#0b0b0c;width:390px;max-width:100%;margin:0 auto;display:block}

    .banner{position:relative;height:160px;border-radius:14px;background:linear-gradient(180deg,rgba(2,132,199,.15),rgba(2,132,199,0));box-shadow:var(--shadow) inset;background-size:cover;background-position:center;margin-bottom:56px}
    .avatar-preview{width:140px;height:140px;border-radius:999px;object-fit:cover;position:absolute;left:50%;transform:translateX(-50%);bottom:-70px;border:4px solid var(--card);box-shadow:var(--shadow);background:#fff;z-index:3}
    .identity{margin-top:90px;text-align:center}
    .identity .name{font-weight:700;font-size:20px;color:var(--tpl-name)}
    .identity .role{color:var(--tpl-role)}
    .identity .company{color:var(--tpl-role);margin-top:2px}

    .social-row{display:flex;align-items:center;justify-content:center;gap:14px;flex-wrap:wrap;margin:10px 0 6px}
    .social-row a{display:inline-flex;width:28px;height:28px}
    .social-row img{width:28px;height:28px;display:block}

    .list{display:grid;gap:10px;margin-top:12px}
    .item{display:flex;gap:12px;align-items:center;padding:12px;border:1px solid var(--border);background:var(--tpl-sec-bg);border-radius:12px;color:var(--tpl-sec-text)}
    .item .ic{font-size:20px;line-height:1;width:28px;display:grid;place-items:center;color:var(--tpl-sec-text)}
    .item .txt{display:flex;flex-direction:column;color:var(--tpl-sec-text)}
    .item .txt .label{font-weight:600}
    .item .txt .sub{opacity:.8;font-size:13px}

    .cta{background:var(--tpl-cta-bg);color:var(--tpl-cta-text)!important;border-color:transparent}
    .cta.big{display:block;width:max-content;margin:12px auto 0}
    .preview-canvas{background:var(--tpl-bg);padding:16px;border-radius:14px;border:1px solid var(--border)}

    /* Rows */
    .rows{display:grid;gap:10px}
    .row{display:grid;grid-template-columns:56px 1.2fr 1.2fr 1fr 120px 40px;gap:10px;align-items:center}
    .row-website{display:grid;grid-template-columns:56px 1fr 2fr 40px;gap:10px;align-items:center}
    .row-social{display:grid;grid-template-columns:160px 1fr 40px;gap:10px;align-items:center}
    .row-address{display:grid;grid-template-columns:56px 160px minmax(220px,2fr) 110px minmax(180px,1.4fr) 100px 40px;gap:10px;align-items:center}
    .row input[type=text],.row input[type=url],.row input[type=email],.row input[type=tel],.row select,.row-website input,.row-website select,.row-social input,.row-social select,.row-address input,.row-address select{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--bg-elevated)}
    .row .emoji{font-size:20px;text-align:center}
    .remove{display:grid;place-items:center;height:40px;border-radius:10px;border:1px solid var(--border);background:var(--bg-elevated);cursor:pointer}
    .toggle{display:flex;align-items:center;gap:8px}

    @media (max-width:980px){
      .app{grid-template-columns:1fr}
      .grid12{grid-template-columns:1fr}
      .row{grid-template-columns:56px 1fr 1fr 1fr 1fr 40px}
      .row-website{grid-template-columns:56px 1fr 1fr 40px}
      .row-social{grid-template-columns:160px 1fr 40px}
      .row-address{grid-template-columns:56px 1fr 2fr 1fr 1.2fr 1fr 40px}
    }
    /* Wallet Preview (EXAKT aus Template) */
:root{
  /* Fallbacks; echte Farben k√∂nnen sp√§ter vom Template gesetzt werden */
  --pass-bg:#C9E5F3;
  --pass-text:#0b0b0c;
}

/* Wallet Card ‚Äì 1080:1503 ‚Üí 390√ó543 fix */
.wallet{
  background:var(--pass-bg); color:var(--pass-text);
  border-radius:28px; border:1px solid var(--border); box-shadow:0 10px 30px rgba(0,0,0,.08);
  padding:24px; width:100%; height:543px;
  display:flex; flex-direction:column; row-gap:4px;
}
.logo-strip{height:40px;display:flex;align-items:center}
.logo-strip img{height:40px;width:auto;max-width:60%;object-fit:contain}
.name-row{
  display:grid;
  grid-template-columns:minmax(0,1fr) 104px; /* Foto-Spalte fix */
  gap:16px; align-items:center; margin-top:6px;
}
.headshot{justify-self:end;width:82px;height:82px;border-radius:10px;overflow:hidden;background:#fff;border:1px solid var(--border);margin-top:6px}
.headshot img{width:100%;height:100%;object-fit:cover}
.h{
  font-size:12px;letter-spacing:.12em;
  color:color-mix(in oklab, var(--pass-text) 55%, #9aa1aa);
  text-transform:uppercase;margin:8px 0 2px;
}
.name{font-weight:400;font-size:26px;line-height:1.05;white-space:nowrap;overflow:hidden}
.company{font-size:18px;margin-top:0}
.title{font-size:16px;margin-top:0}
.spacer{flex:1 1 auto} /* schiebt QR nach unten */
#walletQr{
  background:#fff;border:1px solid var(--border);border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,.06);
  padding:2px 2px 0;
  align-self:center;margin-bottom:8px;
}
#walletQrImg{width:146px !important;height:146px !important;object-fit:contain;image-rendering:pixelated}
#walletQrCaption{margin-top:2px;font-size:14px;letter-spacing:.02em;color:#000 !important;text-align:center}

  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="brand-logo">PPS</div>
        <div>
          <div class="brand-name">PPS Business Cards</div>
          <div id="companyNameBadge" style="color:var(--muted);font-size:12px">‚Äî</div>
        </div>
      </div>
      <nav class="nav">
        <h4>√úbersicht</h4>
        <a href="dashboard.html"><span>üè†</span><span>Dashboard</span></a>
        <div style="height:1px;background:var(--border);margin:10px 0;border-radius:2px"></div>
        <h4>Visitenkarten</h4>
        <a href="cards.html"><span>üóÇÔ∏è</span><span>Alle Karten</span></a>
        <a class="active" href="new.html"><span>‚ûï</span><span>Erstellen</span></a>
        <a href="import.html"><span>‚¨ÜÔ∏è</span><span>CSV-Import</span></a>
        <h4>Design</h4>
        <a href="template.html"><span>üé®</span><span>Template</span></a>
        <h4>System</h4>
        <a href="settings.html"><span>‚öôÔ∏è</span><span>Einstellungen</span></a>
        <a href="docs.html"><span>üìò</span><span>API-Dokumentation</span></a>
      </nav>
    </aside>

    <div class="main">
      <header class="header">
        <h1>Neue Karte</h1>
        <div class="avatar">A</div>
      </header>

      <main class="content">
        <section class="grid12">
          <!-- FORM (left) -->
          <form id="cardForm" class="grid12" onsubmit="return false;" style="grid-column: span 7;">
            <!-- Person -->
            <div class="subhead" style="grid-column: span 12;">Person</div>
            <div class="field" style="grid-column: span 12;"><label>Foto</label><input type="file" id="photo" accept="image/*" /></div>

            <div class="field" style="grid-column: span 4;"><label>Prefix</label><input id="honorificPrefix" type="text" placeholder="Dr." /></div>
            <div class="field" style="grid-column: span 4;"><label>Vorname *</label><input id="givenName" required value="Max" placeholder="Max" /></div>
            <div class="field" style="grid-column: span 4;"><label>Nachname *</label><input id="familyName" required value="Mustermann" placeholder="Mustermann" /></div>

            <div class="field" style="grid-column: span 4;"><label>Mittelname</label><input id="additionalName" type="text" placeholder="‚Äî" /></div>
            <div class="field" style="grid-column: span 4;"><label>Suffix</label><input id="honorificSuffix" type="text" placeholder="MBA" /></div>
            <div class="field" style="grid-column: span 4;"><label>Anzeige‚ÄëName</label><input id="displayName" type="text" placeholder="Dr. Max Mustermann" /></div>

            <div class="field" style="grid-column: span 6;"><label>Position *</label><input id="role" required placeholder="Sales Manager" /></div>
            <div class="field" style="grid-column: span 6;"><label>Abteilung</label><input id="department" placeholder="Sales" /></div>
            <div class="field" style="grid-column: span 12;"><label>Firmenname</label><input id="companyName" placeholder="Firmenname" /></div>

            <!-- Kontakt: Telefonnummern -->
            <div class="subhead" style="grid-column: span 12; margin-top:6px;">Telefonnummern</div>
            <div id="phoneRows" class="rows" style="grid-column: span 12;"></div>
            <div style="grid-column: span 12; display:flex; gap:8px; align-items:center;">
              <button class="btn inline" id="addPhone" type="button">Ôºã Telefonnummer hinzuf√ºgen</button>
              <span class="note">Max. 4 Nummern. "Ausblenden" verbirgt nur in der Landingpage ‚Äì vCard enth√§lt die Nummer weiterhin.</span>
            </div>

            <!-- Kontakt: E‚ÄëMails -->
            <div class="subhead" style="grid-column: span 12; margin-top:6px;">E‚ÄëMail‚ÄëAdressen</div>
            <div id="emailRows" class="rows" style="grid-column: span 12;"></div>
            <div style="grid-column: span 12; display:flex; gap:8px; align-items:center;">
              <button class="btn inline" id="addEmail" type="button">Ôºã E‚ÄëMail hinzuf√ºgen</button>
              <span class="note">Max. 4 E‚ÄëMails. "Ausblenden" betrifft nur die Landingpage ‚Äì vCard erh√§lt alle.</span>
            </div>

            <!-- Websites (vererbt) -->
            <div class="subhead" style="grid-column: span 12; margin-top:6px;">Websites</div>
            <div id="webRows" class="rows" style="grid-column: span 12;"></div>
            <div style="grid-column: span 12; display:flex; gap:8px; align-items:center;">
              <button class="btn inline" id="addWebsite" type="button">Ôºã Website hinzuf√ºgen</button>
              <span class="note">Max. 5 Websites. Aus Template √ºbernommen, hier pro Karte anpassbar.</span>
            </div>

            <!-- Adressen (vererbt) -->
            <div class="subhead" style="grid-column: span 12; margin-top:6px;">Adressen</div>
            <div id="addrRows" class="rows" style="grid-column: span 12;"></div>
            <div style="grid-column: span 12; display:flex; gap:8px; align-items:center;">
              <button class="btn inline" id="addAddress" type="button">Ôºã Adresse hinzuf√ºgen</button>
              <span class="note">Max. 3 Adressen. Aus Template √ºbernommen, hier pro Karte anpassbar.</span>
            </div>

            <!-- Socials (vererbt) -->
            <div class="subhead" style="grid-column: span 12; margin-top:6px;">Social Media</div>
            <div id="socialRows" class="rows" style="grid-column: span 12;"></div>
            <div style="grid-column: span 12; display:flex; gap:8px; align-items:center;">
              <button class="btn inline" id="addSocial" type="button">Ôºã Social hinzuf√ºgen</button>
              <span class="note">Vorbelegt aus Template. Leere Zeilen werden nicht angezeigt.</span>
            </div>

            <!-- Zus√§tzliche Buttons (vererbt) -->
            <div class="subhead" style="grid-column: span 12; margin-top:6px;">Zus√§tzliche Buttons</div>
            <div class="rows" id="btnRows" style="grid-column: span 12;"></div>
            <div style="grid-column: span 12; display:flex; gap:8px; align-items:center;">
              <button class="btn inline" id="addRow" type="button">Ôºã Button hinzuf√ºgen</button>
              <span class="note">Max. 6. Keys/IDs sind readonly (btn1 ‚Ä¶) und bleiben stabil.</span>
            </div>

            <div style="grid-column: span 12; display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
              <button class="btn" id="saveDraft" type="button">Entwurf speichern</button>
              <button class="btn primary" id="createCard" type="button">Karte erstellen</button>
            </div>
          </form>

          <!-- PREVIEW (right) -->
          <aside class="panel" style="grid-column: span 5;">
            <div class="panel-header">
              <strong>Live-Preview</strong>
              <nav class="segment" role="tablist" aria-label="Preview" style="margin-left:auto">
                <a id="tabLanding" class="active" role="tab" aria-selected="true" href="#" data-target="landing">Landingpage</a>
                <a id="tabWallet" role="tab" aria-selected="false" href="#" data-target="wallet">Wallet</a>
              </nav>
            </div>
            <div class="panel-body">
              <div id="landingPanel">
                <div id="previewRoot" class="preview-canvas">
                  <div class="banner" id="previewBanner">
                    <img id="previewPhoto" class="avatar-preview" alt="Foto" src="../assets/foto.webp" />
                  </div>
                  <div class="identity">
                    <div class="name" id="previewName">‚Äî</div>
                    <div class="role" id="previewRoleDept">‚Äî</div>
                    <div class="company" id="previewCompany">‚Äî</div>
                  </div>
                  <a class="btn big cta" href="#">Kontaktdaten speichern</a>
                  <div class="social-row" id="socialIcons"></div>
                  <div class="list" id="webButtons"></div>
                  <div class="list" id="addrButtons"></div>
                  <div class="list" id="tplButtonsList"></div>
                </div>
              </div>

			<div id="walletPanel" style="display:none">
  <div class="preview-canvas" style="width:390px;max-width:100%;margin:0 auto;">
    <div id="wallet" class="wallet">
      <div class="logo-strip"><img id="walletLogo" alt="Logo" /></div>

      <div class="name-row">
        <div>
          <div class="h" id="wHName">NAME</div>
          <div class="name" id="wName">Max Mustermann</div>
        </div>
        <div class="headshot" title="Profilfoto">
          <img id="walletHeadshot" src="../assets/foto.webp" alt="Profil" />
        </div>
      </div>

      <div class="h" id="wHCompany">FIRMENNAME</div>
      <div class="company" id="wCompany">Mustermann GmbH</div>

      <div class="h" id="wHTitle">TITEL</div>
      <div class="title" id="wTitle">Sales Manager</div>

      <div class="spacer"></div>

      <div id="walletQr">
        <img id="walletQrImg" src="../assets/qr.png" alt="QR-Code" />
        <div id="walletQrCaption">QR-Code scannen</div>
      </div>
    </div>
  </div>
</div>
            </div>
          </aside>
        </section>
      </main>
    </div>
  </div>

  <script>
    // ===== Mock: Template JSON laden (in echter App via API/State) =====
    const TEMPLATE = {
      branding:{ bg:'#ffffff', name:'#0b0b0c', role:'#6b7280', cta_bg:'#F7F7F8', cta_text:'#0b0b0c', sec_bg:'#f3f4f6', sec_text:'#0b0b0c', banner:null },
      company_name:'Mustermann GmbH',
      websites:[{emoji:'üåê',label:'Website',url:'https://firma.de'}],
      addresses:[{type:'work',emoji:'üìç',street:'Hauptstra√üe 1',postal_code:'10115',locality:'Berlin',country:'DE'}],
      socials:[{platform:'linkedin',url:'https://linkedin.com/company/firma'},{platform:'whatsapp',url:'https://wa.me/491234567890'}],
      extra_buttons:[{emoji:'üìÑ',label:'Brosch√ºre',key:'btn1',url:'https://firma.de/brochure.pdf'},{emoji:'üóìÔ∏è',label:'Termin buchen',key:'btn2',url:'https://cal.com/firma/team'}]
    };

    // ===== Tabs in Preview =====
    const tabLanding=document.getElementById('tabLanding');
    const tabWallet=document.getElementById('tabWallet');
    const landingPanel=document.getElementById('landingPanel');
    const walletPanel=document.getElementById('walletPanel');
    function switchTab(target){
      const isLanding=target==='landing';
      tabLanding.classList.toggle('active',isLanding); tabLanding.setAttribute('aria-selected',isLanding);
      tabWallet.classList.toggle('active',!isLanding); tabWallet.setAttribute('aria-selected',!isLanding);
      landingPanel.style.display=isLanding?'block':'none';
      walletPanel.style.display=isLanding?'none':'block';
    }
    tabLanding.addEventListener('click',e=>{e.preventDefault();switchTab('landing');});
    tabWallet.addEventListener('click',e=>{e.preventDefault();switchTab('wallet');});

    // ===== Helpers =====
    function readAsDataURL(file, cb){ const r=new FileReader(); r.onload=()=>cb(r.result); r.readAsDataURL(file); }

    // ===== Branding aus Template anwenden (read-only) =====
    const root=document.getElementById('previewRoot');
    const walletBanner=document.getElementById('walletBanner');
    function applyTemplateBranding(tpl){
      root.style.setProperty('--tpl-bg', tpl.branding.bg || '#ffffff');
      root.style.setProperty('--tpl-name', tpl.branding.name || '#0b0b0c');
      root.style.setProperty('--tpl-role', tpl.branding.role || '#6b7280');
      root.style.setProperty('--tpl-cta-bg', tpl.branding.cta_bg || '#F7F7F8');
      root.style.setProperty('--tpl-cta-text', tpl.branding.cta_text || '#0b0b0c');
      root.style.setProperty('--tpl-sec-bg', tpl.branding.sec_bg || '#f3f4f6');
      root.style.setProperty('--tpl-sec-text', tpl.branding.sec_text || '#0b0b0c');
      if(tpl.branding.banner){
          document.getElementById('previewBanner').style.backgroundImage=`url('${tpl.branding.banner}')`;
	  if (walletBanner) walletBanner.style.backgroundImage=`url('${tpl.branding.banner}')`;
      }
    }
    applyTemplateBranding(TEMPLATE);

    // ===== Company Name in Sidebar + Preview vorbelegen =====
    const companyNameInput=document.getElementById('companyName');
    const companyNameBadge=document.getElementById('companyNameBadge');
    const previewCompany=document.getElementById('previewCompany');
    companyNameInput.value=TEMPLATE.company_name||'';
    companyNameBadge.textContent=TEMPLATE.company_name||'‚Äî';
    previewCompany.textContent=TEMPLATE.company_name||'‚Äî';
    companyNameInput.addEventListener('input',()=>{
      const v=companyNameInput.value||'‚Äî'; companyNameBadge.textContent=v; previewCompany.textContent=v; renderIdentity();
    });

    // ===== Person: Live Identity =====
    const previewName=document.getElementById('previewName');
    const previewRoleDept=document.getElementById('previewRoleDept');
    const walletName=document.getElementById('walletName');
    const walletRole=document.getElementById('walletRole');
    function readPerson(){
      return {
        honorific_prefix: document.getElementById('honorificPrefix').value.trim(),
        given_name: document.getElementById('givenName').value.trim(),
        additional_name: document.getElementById('additionalName').value.trim(),
        family_name: document.getElementById('familyName').value.trim(),
        honorific_suffix: document.getElementById('honorificSuffix').value.trim(),
        display_name: document.getElementById('displayName').value.trim(),
        role: document.getElementById('role').value.trim(),
        department: document.getElementById('department').value.trim(),
        company: document.getElementById('companyName').value.trim()
      };
    }
    function makeDisplayName(p){
      const base = p.display_name || [p.honorific_prefix,p.given_name,p.additional_name,p.family_name,p.honorific_suffix].filter(Boolean).join(' ').replace(/\s+/g,' ').trim();
      return base || '‚Äî';
    }
    function renderIdentity(){
      const p=readPerson();
      const name=makeDisplayName(p);
      previewName.textContent=name;
      const roleDept=[p.role,p.department].filter(Boolean).join(' ¬∑ ')||'‚Äî';
      previewRoleDept.textContent=roleDept;
	  if (walletName) walletName.textContent = name;
	  if (walletRole) walletRole.textContent = roleDept;

    }
    ['honorificPrefix','givenName','additionalName','familyName','honorificSuffix','displayName','role','department']
      .forEach(id=>document.getElementById(id).addEventListener('input',renderIdentity));
    renderIdentity();

    // ===== Foto Upload =====
    const previewPhoto=document.getElementById('previewPhoto');
	const walletHeadshot = document.getElementById('walletHeadshot');
	document.getElementById('photo').addEventListener('change',(e)=>{
	  const f=e.target.files?.[0]; if(!f) return; readAsDataURL(f,(src)=>{ 
	    previewPhoto.src = src; 
    if (walletHeadshot) walletHeadshot.src = src; 
    photo_upload_id = 'up_mock_' + Date.now(); 
  });
});

    let photo_upload_id = null; // wird in echter App vom Upload-Endpunkt gesetzt

    // ===== Socials (1:1 wie Template) =====
    const ICONS={linkedin:'../assets/icons8-linkedin-50.png',instagram:'../assets/icons8-instagram-50.png',facebook:'../assets/icons8-facebook-50.png',tiktok:'../assets/icons8-tiktok-50.png',whatsapp:'../assets/icons8-whatsapp-50.png',youtube:'../assets/icons8-youtube-50.png'};
    const socialRows=document.getElementById('socialRows');
    const socialIcons=document.getElementById('socialIcons');
    function addSocialRow(vals){
      const div=document.createElement('div'); div.className='row-social';
      div.innerHTML=`
        <select title="Plattform">
          <option value="linkedin">LinkedIn</option>
          <option value="instagram">Instagram</option>
          <option value="facebook">Facebook</option>
          <option value="tiktok">TikTok</option>
          <option value="whatsapp">WhatsApp</option>
          <option value="youtube">YouTube</option>
        </select>
        <input type="url" placeholder="https://‚Ä¶" />
        <button class="remove" type="button" title="Entfernen">‚úñ</button>`;
      socialRows.appendChild(div);
      if(vals){ div.querySelector('select').value=vals.platform||'linkedin'; div.querySelector('input').value=vals.url||''; }
    }
    function serializeSocials(){ return [...socialRows.querySelectorAll('.row-social')].map(r=>({ platform:r.querySelector('select').value, url:r.querySelector('input').value.trim() })).filter(x=>x.url); }
    function renderSocials(){ socialIcons.innerHTML=''; serializeSocials().forEach(s=>{ const a=document.createElement('a'); a.href=s.url.startsWith('http')?s.url:(s.platform==='whatsapp'?('https://wa.me/'+s.url.replace(/\D/g,'')):'#'); a.target='_blank'; a.rel='noopener'; const img=document.createElement('img'); img.src=ICONS[s.platform]||ICONS.linkedin; img.alt=s.platform; a.appendChild(img); socialIcons.appendChild(a); }); }
    document.getElementById('addSocial').addEventListener('click',()=>{ addSocialRow(); renderSocials(); });
    socialRows.addEventListener('input',renderSocials);
    socialRows.addEventListener('click',(e)=>{ if(e.target.closest('.remove')){ e.target.closest('.row-social').remove(); renderSocials(); }});

    // ===== Websites (1:1 wie Template) =====
    const webRows=document.getElementById('webRows');
    const webButtons=document.getElementById('webButtons');
    function addWebsiteRow(vals){ const div=document.createElement('div'); div.className='row-website'; div.innerHTML=`<div class="emoji" contenteditable="true" aria-label="Emoji" title="Emoji">üåê</div><input type="text" placeholder="Label" /><input type="url" placeholder="https://‚Ä¶" /><button class="remove" type="button" title="Entfernen">‚úñ</button>`; webRows.appendChild(div); if(vals){ div.querySelector('.emoji').textContent=vals.emoji||'üåê'; div.querySelectorAll('input')[0].value=vals.label||''; div.querySelectorAll('input')[1].value=vals.url||''; } }
    function serializeWebsites(){ return [...webRows.querySelectorAll('.row-website')].map(r=>{ const emoji=(r.querySelector('.emoji')?.textContent||'üåê').trim(); const [label,url]=r.querySelectorAll('input'); return {emoji, label:label.value.trim(), url:url.value.trim()}; }).filter(x=>x.label&&x.url); }
    function renderWebsites(){ webButtons.innerHTML=''; serializeWebsites().forEach(r=>{ const a=document.createElement('a'); a.href=r.url; a.target='_blank'; a.rel='noopener'; a.className='item'; const ic=document.createElement('div'); ic.className='ic'; ic.textContent=r.emoji; a.appendChild(ic); const txt=document.createElement('div'); txt.className='txt'; const l=document.createElement('div'); l.className='label'; l.textContent=r.label; txt.appendChild(l); const s=document.createElement('div'); s.className='sub'; s.textContent=r.url; txt.appendChild(s); a.appendChild(txt); webButtons.appendChild(a); }); }
    document.getElementById('addWebsite').addEventListener('click',()=>{ if(webRows.querySelectorAll('.row-website').length>=5) return; addWebsiteRow(); renderWebsites(); });
    webRows.addEventListener('input',renderWebsites);
    webRows.addEventListener('click',(e)=>{ if(e.target.closest('.remove')){ e.target.closest('.row-website').remove(); renderWebsites(); }});

    // ===== Addresses (1:1 wie Template) =====
    const addrRows=document.getElementById('addrRows');
    const addrButtons=document.getElementById('addrButtons');
    function addAddressRow(vals){ const div=document.createElement('div'); div.className='row-address'; div.innerHTML=`<div class="emoji" contenteditable="true" aria-label="Emoji" title="Emoji">üìç</div><select title="Typ"><option value="work">Gesch√§ftlich</option><option value="home">Privat</option><option value="other">Sonstiges</option></select><input type="text" placeholder="Stra√üe" /><input type="text" placeholder="PLZ" /><input type="text" placeholder="Stadt" /><input type="text" placeholder="Land" /><button class="remove" type="button" title="Entfernen">‚úñ</button>`; addrRows.appendChild(div); if(vals){ div.querySelector('.emoji').textContent=vals.emoji||'üìç'; const nodes=div.querySelectorAll('select, input'); nodes[0].value=vals.type||'work'; nodes[1].value=vals.street||''; nodes[2].value=vals.postal_code||''; nodes[3].value=vals.locality||''; nodes[4].value=vals.country||''; } }
    function serializeAddresses(){ return [...addrRows.querySelectorAll('.row-address')].map(r=>{ const emoji=(r.querySelector('.emoji')?.textContent||'üìç').trim(); const nodes=r.querySelectorAll('select, input'); const typeSel=nodes[0]; const street=nodes[1]; const zip=nodes[2]; const city=nodes[3]; const country=nodes[4]; return {emoji,type:typeSel?.value||'work',street:street?.value?.trim()||'',postal_code:zip?.value?.trim()||'',locality:city?.value?.trim()||'',country:country?.value?.trim()||''}; }).filter(a=>a.street&&a.postal_code&&a.locality&&a.country); }
    function mapsUrl(a){ const q=`${a.street}, ${a.postal_code} ${a.locality}, ${a.country}`; return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`; }
    function renderAddresses(){ addrButtons.innerHTML=''; serializeAddresses().forEach(a=>{ const link=document.createElement('a'); link.href=mapsUrl(a); link.target='_blank'; link.rel='noopener'; link.className='item'; const ic=document.createElement('div'); ic.className='ic'; ic.textContent=a.emoji; link.appendChild(ic); const txt=document.createElement('div'); txt.className='txt'; const l=document.createElement('div'); l.className='label'; l.textContent=a.street; txt.appendChild(l); const s=document.createElement('div'); s.className='sub'; s.textContent=`${a.postal_code} ${a.locality}, ${a.country}`; txt.appendChild(s); link.appendChild(txt); addrButtons.appendChild(link); }); }
    document.getElementById('addAddress').addEventListener('click',()=>{ const count=addrRows.querySelectorAll('.row-address').length; if(count>=3) return; addAddressRow(); renderAddresses(); });
    addrRows.addEventListener('input',renderAddresses);
    addrRows.addEventListener('click',(e)=>{ if(e.target.closest('.remove')){ e.target.closest('.row-address').remove(); renderAddresses(); }});

    // ===== Template Buttons (1:1 wie Template) =====
    const btnRows=document.getElementById('btnRows');
    const tplButtonsList=document.getElementById('tplButtonsList');
    function addTplButtonRow(vals){ const count=btnRows.querySelectorAll('.row').length; if(count>=6) return; const idx=count+1; const div=document.createElement('div'); div.className='row'; div.dataset.key= vals?.key || ('btn'+idx); div.innerHTML=`<div class=\"emoji\" contenteditable=\"true\" aria-label=\"Emoji\" title=\"Emoji\">${vals?.emoji||'üîó'}</div><input type=\"text\" placeholder=\"Label\" value=\"${vals?.label||''}\" /><input type=\"text\" placeholder=\"Schl√ºssel\" value=\"${vals?.key||('btn'+idx)}\" readonly style=\"opacity:.7\" /><input type=\"url\" placeholder=\"https://‚Ä¶\" value=\"${vals?.url||''}\" /><button class=\"remove\" type=\"button\" title=\"Entfernen\">‚úñ</button>`; btnRows.appendChild(div); }
    function serializeTplButtons(){ return [...btnRows.querySelectorAll('.row')].map(row=>{ const emoji=row.querySelector('.emoji').textContent.trim()||'üîó'; const [label,key,url]=row.querySelectorAll('input'); return {emoji,label:(label?.value||'').trim(),key:(key?.value||'').trim(),url:(url?.value||'').trim()}; }).filter(r=>r.label&&r.key&&r.url); }
    function renderTplButtons(){ tplButtonsList.innerHTML=''; serializeTplButtons().forEach(r=>{ const a=document.createElement('a'); a.href=r.url; a.className='item'; a.target='_blank'; a.rel='noopener'; const ic=document.createElement('div'); ic.className='ic'; ic.textContent=r.emoji; a.appendChild(ic); const txt=document.createElement('div'); txt.className='txt'; const l=document.createElement('div'); l.className='label'; l.textContent=r.label; txt.appendChild(l); const s=document.createElement('div'); s.className='sub'; s.textContent=r.url; txt.appendChild(s); a.appendChild(txt); tplButtonsList.appendChild(a); }); }
    btnRows.addEventListener('input',renderTplButtons);
    btnRows.addEventListener('click',(e)=>{ if(e.target.closest('.remove')){ e.target.closest('.row').remove(); renderTplButtons(); } });
    document.getElementById('addRow').addEventListener('click',()=>{ addTplButtonRow(); renderTplButtons(); });
    // enforce readonly for all key fields (also dynamic)
    (function(){ const mo=new MutationObserver(()=>{ btnRows.querySelectorAll('.row').forEach(row=>{ const key=row.querySelectorAll('input')[1]; if(key){ key.readOnly=true; key.style.opacity='.7'; } }); }); mo.observe(btnRows,{childList:true,subtree:true}); })();

    // ===== Phones & Emails (mit Toggle f√ºr Landingpage) =====
    const phoneRows=document.getElementById('phoneRows');
    function addPhoneRow(vals){
      const count=phoneRows.querySelectorAll('.row').length; if(count>=4) return;
      const div=document.createElement('div'); div.className='row';
      div.innerHTML=`
        <div class="emoji" contenteditable="true" title="Icon">${vals?.emoji||'üìû'}</div>
        <select title="Typ">
          <option value="work">Arbeit</option>
          <option value="work_mobile">Arbeit Mobil</option>
          <option value="mobile">Mobil</option>
          <option value="home">Privat</option>
          <option value="fax">Fax</option>
          <option value="other">Sonstiges</option>
        </select>
        <input type="tel" placeholder="+49 ‚Ä¶" />
        <div class="toggle" title="Auf Landingpage anzeigen"><input type="checkbox" class="showLP" checked /> <span class="note">anzeigen</span></div>
        <div class="note">E.164 empfohlen</div>
        <button class="remove" type="button" title="Entfernen">‚úñ</button>`;
      phoneRows.appendChild(div);
      if(vals){ div.querySelector('.emoji').textContent=vals.emoji||'üìû'; div.querySelector('select').value=vals.type||'work'; div.querySelector('input[type=tel]').value=vals.value||''; div.querySelector('.showLP').checked = vals.show_on_lp!==false; }
    }
    function serializePhones(){ return [...phoneRows.querySelectorAll('.row')].map(r=>({ emoji:(r.querySelector('.emoji')?.textContent||'üìû').trim(), type:r.querySelector('select').value, value:r.querySelector('input[type=tel]').value.trim(), show_on_lp:r.querySelector('.showLP').checked })).filter(x=>x.value); }

    const emailRows=document.getElementById('emailRows');
    function addEmailRow(vals){
      const count=emailRows.querySelectorAll('.row').length; if(count>=4) return;
      const div=document.createElement('div'); div.className='row';
      div.innerHTML=`
        <div class="emoji" contenteditable="true" title="Icon">${vals?.emoji||'‚úâÔ∏è'}</div>
        <select title="Typ">
          <option value="work">Arbeit</option>
          <option value="personal">Privat</option>
          <option value="other">Sonstiges</option>
        </select>
        <input type="email" placeholder="max@firma.de" />
        <div class="toggle" title="Auf Landingpage anzeigen"><input type="checkbox" class="showLP" checked /> <span class="note">anzeigen</span></div>
        <div class="note">E‚ÄëMail‚ÄëFormat</div>
        <button class="remove" type="button" title="Entfernen">‚úñ</button>`;
      emailRows.appendChild(div);
      if(vals){ div.querySelector('.emoji').textContent=vals.emoji||'‚úâÔ∏è'; div.querySelector('select').value=vals.type||'work'; div.querySelector('input[type=email]').value=vals.value||''; div.querySelector('.showLP').checked = vals.show_on_lp!==false; }
    }
    function serializeEmails(){ return [...emailRows.querySelectorAll('.row')].map(r=>({ emoji:(r.querySelector('.emoji')?.textContent||'‚úâÔ∏è').trim(), type:r.querySelector('select').value, value:r.querySelector('input[type=email]').value.trim(), show_on_lp:r.querySelector('.showLP').checked })).filter(x=>x.value); }

    document.getElementById('addPhone').addEventListener('click',()=>{ addPhoneRow({type:'work'}); renderContactButtons(); });
    document.getElementById('addEmail').addEventListener('click',()=>{ addEmailRow({type:'work'}); renderContactButtons(); });
    phoneRows.addEventListener('input',renderContactButtons);
    emailRows.addEventListener('input',renderContactButtons);
    phoneRows.addEventListener('click',(e)=>{ if(e.target.closest('.remove')){ e.target.closest('.row').remove(); renderContactButtons(); }});
    emailRows.addEventListener('click',(e)=>{ if(e.target.closest('.remove')){ e.target.closest('.row').remove(); renderContactButtons(); }});

    // ===== Preview: Kontakt-Buttons + (darunter) Websites, Adressen, Extra Buttons =====
    function renderContactButtons(){
      const old = document.getElementById('contactButtons'); if(old) old.remove();
      const wrap=document.createElement('div'); wrap.className='list'; wrap.id='contactButtons';
      const phones=serializePhones();
      phones.filter(p=>p.show_on_lp).forEach(p=>{
        const a=document.createElement('a'); a.href=`tel:${p.value.replace(/\s+/g,'')}`; a.className='item';
        const ic=document.createElement('div'); ic.className='ic'; ic.textContent=p.emoji||'üìû'; a.appendChild(ic);
        const txt=document.createElement('div'); txt.className='txt';
        const l=document.createElement('div'); l.className='label'; l.textContent=({work:'Anrufen (Arbeit)',work_mobile:'Mobil (Arbeit)',mobile:'Mobil',home:'Privat',fax:'Fax',other:'Telefon'})[p.type]||'Telefon'; txt.appendChild(l);
        const s=document.createElement('div'); s.className='sub'; s.textContent=p.value; txt.appendChild(s);
        a.appendChild(txt); wrap.appendChild(a);
      });
      const emails=serializeEmails();
      emails.filter(m=>m.show_on_lp).forEach(m=>{
        const a=document.createElement('a'); a.href=`mailto:${m.value}`; a.className='item';
        const ic=document.createElement('div'); ic.className='ic'; ic.textContent=m.emoji||'‚úâÔ∏è'; a.appendChild(ic);
        const txt=document.createElement('div'); txt.className='txt';
        const l=document.createElement('div'); l.className='label'; l.textContent=({work:'E‚ÄëMail (Arbeit)',personal:'E‚ÄëMail (Privat)',other:'E‚ÄëMail'})[m.type]||'E‚ÄëMail'; txt.appendChild(l);
        const s=document.createElement('div'); s.className='sub'; s.textContent=m.value; txt.appendChild(s);
        a.appendChild(txt); wrap.appendChild(a);
      });
      const socialRow=document.getElementById('socialIcons');
      socialRow.insertAdjacentElement('afterend', wrap);
    }

    // ===== Initialisierung aus Template =====
    (function initFromTemplate(){
      (TEMPLATE.socials||[]).forEach(s=>addSocialRow(s)); renderSocials();
      (TEMPLATE.websites||[]).forEach(w=>addWebsiteRow(w)); renderWebsites();
      (TEMPLATE.addresses||[]).forEach(a=>addAddressRow(a)); renderAddresses();
      (TEMPLATE.extra_buttons||[]).forEach(b=>addTplButtonRow(b)); renderTplButtons();
      addPhoneRow({type:'work'}); addEmailRow({type:'work'}); renderContactButtons();
    })();

    // ===== Speichern: Card‚ÄëJSON =====
    function buildPayload(){
      const p=readPerson();
      const payload={
        company_slug: (p.company||TEMPLATE.company_name||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''),
        template_id: 'tpl_12345',
        person: {
          honorific_prefix: p.honorific_prefix,
          given_name: p.given_name,
          additional_name: p.additional_name,
          family_name: p.family_name,
          display_name: p.display_name || makeDisplayName(p),
          role: p.role,
          department: p.department,
          honorific_suffix: p.honorific_suffix
        },
        phones: serializePhones().map(({type,value})=>({type,value})),
        emails: serializeEmails().map(({type,value})=>({type,value})),
        addresses: serializeAddresses(),
        websites: serializeWebsites(),
        socials: serializeSocials(),
        extra_buttons: serializeTplButtons(),
        photo_upload_id: photo_upload_id
      };
      return payload;
    }

    function validateSoft(){
      function ensureHttps(u){ if(!u) return u; if(!/^https?:\/\//i.test(u)) return 'https://'+u; return u; }
      document.querySelectorAll('#webRows input[type=url], #btnRows input[type=url]').forEach(inp=>{ const v=inp.value.trim(); if(v && !/^https?:\/\//i.test(v)) inp.value='https://'+v; });
    }

    document.getElementById('saveDraft').addEventListener('click',()=>{ validateSoft(); const data=buildPayload(); console.log('Draft:', data); alert('Entwurf lokal vorbereitet (siehe Console).'); });
    document.getElementById('createCard').addEventListener('click',()=>{ validateSoft(); const data=buildPayload(); console.log('Create:', data); alert('Karte wird erstellt (Demo) ‚Äì Payload in der Console.'); });
  </script>
  
  <script>
// ---------- Wallet Preview: Binding (read-only) ----------
(function(){
  function setPassColors(bg, text){
    if(bg) document.documentElement.style.setProperty('--pass-bg', bg);
    if(text) document.documentElement.style.setProperty('--pass-text', text);
  }
  // Optional: setPassColors('#C9E5F3','#0b0b0c');

  const wName     = document.getElementById('wName');
  const wCompany  = document.getElementById('wCompany');
  const wTitle    = document.getElementById('wTitle');
  const wHeadshot = document.getElementById('walletHeadshot');

  function readPerson(){
    const honorific = document.getElementById('honorificPrefix')?.value?.trim() || '';
    const given     = document.getElementById('givenName')?.value?.trim() || '';
    const middle    = document.getElementById('additionalName')?.value?.trim() || '';
    const family    = document.getElementById('familyName')?.value?.trim() || '';
    const suffix    = document.getElementById('honorificSuffix')?.value?.trim() || '';
    const role      = document.getElementById('role')?.value?.trim() || '';
    const dept      = document.getElementById('department')?.value?.trim() || '';
    const display   = document.getElementById('displayName')?.value?.trim();
    const company   = document.getElementById('companyName')?.value?.trim() || '';

    const nameParts = [honorific, given, middle, family, suffix].filter(Boolean);
    const fullName  = (display || nameParts.join(' ')).replace(/\s+/g,' ').trim() || '‚Äî';
    const roleDept  = [role, dept].filter(Boolean).join(' ¬∑ ') || '‚Äî';
    return { fullName, roleDept, company };
  }

  function fitName(){
    const nameEl = wName, wrap = nameEl?.parentElement;
    if(!nameEl || !wrap) return;
    let size = 26, min = 16;
    nameEl.style.fontSize = size + 'px';
    nameEl.style.whiteSpace = 'nowrap';
    nameEl.style.overflow = 'hidden';
    while (nameEl.scrollWidth > wrap.clientWidth && size > min){
      size -= 1; nameEl.style.fontSize = size + 'px';
    }
  }

  function renderWallet(){
    const p = readPerson();
    if (wName)    wName.textContent    = p.fullName;
    if (wCompany) wCompany.textContent = p.company || '‚Äî';
    if (wTitle)   wTitle.textContent   = p.roleDept;
    fitName();
  }

  // Inputs binden
  ['honorificPrefix','givenName','additionalName','familyName','honorificSuffix','displayName','role','department','companyName']
    .forEach(id => document.getElementById(id)?.addEventListener('input', renderWallet));

  // Foto aus bestehender Preview spiegeln
  const previewPhoto = document.getElementById('previewPhoto');
  document.getElementById('photo')?.addEventListener('change',()=>{
    if (previewPhoto?.src && wHeadshot) wHeadshot.src = previewPhoto.src;
  });

  window.addEventListener('resize', fitName);
  renderWallet();
})();
</script>
  
</body>
</html>
