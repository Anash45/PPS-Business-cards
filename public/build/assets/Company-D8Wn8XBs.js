import{c as J,j as e,r as c,b as y,u as Q,a as X,H as Z,z as l,d as _,D as B}from"./app-BsoacyMg.js";import{A as ee}from"./AuthenticatedLayout-kC2SD7kN.js";import{E as H,D as se}from"./dataTables.dataTables-BTW70Z6i.js";import{D as R,a as f}from"./DropdownUi-BWjSyvGJ.js";import{g as te}from"./viteConfig-gEqUb4HH.js";import{c as ae}from"./csvFieldDefinitions-TqO1r_F2.js";import{W as re,a as ne}from"./WalletEligibilityPill-pwughg1-.js";import{C as le}from"./chevron-down-ZajRXIb_.js";import{S as ce}from"./square-pen-DZnq7v77.js";import{T as oe}from"./trash-2-BWRTOED9.js";import"./ApplicationLogo-tWu073y3.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],O=J("loader-circle",ie);function F({isSyncing:g,syncType:h="normal"}){return g?e.jsxs("div",{className:"bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700 p-4 mb-2 flex items-start gap-3",children:[e.jsx(O,{className:"h-5 w-5 animate-spin flex-shrink-0 mt-1"}),h=="background"?e.jsxs("div",{children:[e.jsx("p",{className:"font-bold",children:"Card Wallets syncing..."}),e.jsx("p",{className:"mt-1 text-sm",children:"⚠️ Syncing in background. You can keep doing your work."})]}):e.jsxs("div",{children:[e.jsx("p",{className:"font-bold",children:"Card Wallets syncing..."}),e.jsx("p",{className:"mt-1 text-sm",children:"⚠️ Keep the page open until it finishes. It may take some time."})]})]}):null}function de({employees:g,setEmployees:h,isSyncingBg:k}){const[w,u]=c.useState(null);return c.useEffect(()=>{if(!k){w&&(clearInterval(w),u(null));return}const b=setInterval(async()=>{try{const d=await y.get("/company/cards/sync-status"),{synced_employees:v}=d.data;v&&v.length&&h(j=>j.map(S=>{const N=v.find(C=>C.id===S.id);return N?{...S,is_syncing:0,wallet_status:N.wallet_status}:S})),g.every(j=>Number(j.is_syncing)===0)&&(clearInterval(b),u(null))}catch(d){console.error("Error checking employee sync status:",d)}},30*1e3);return u(b),()=>clearInterval(b)},[k,g,h]),null}function ue(){return e.jsxs("span",{role:"status","aria-live":"polite",className:"inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 ring-1 ring-blue-200",title:"Syncing",children:[e.jsx(O,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"Syncing"})]})}H.use(se);function Ne(){const{cards:g,isSubscriptionActive:h}=Q().props,{setHeaderTitle:k,setHeaderText:w}=X(),[u,b]=c.useState("https://app.ppsbusinesscards.de"),[d,v]=c.useState(g),A=async a=>{if(window.confirm("This will delete all card details and related data permanently. Are you sure?"))try{const r=await y.put(`/company/cards/${a}/delete`);r.data.success?(l.success(r.data.message),_.reload({only:["cards"]}),typeof refreshTable=="function"&&refreshTable()):l.error(r.data.message||"Failed to delete card.")}catch(r){console.error(r),l.error(r.response?.data?.message||"An error occurred while deleting the card.")}},j=async()=>{if(!i||i.length===0){l.error("Please select at least one employee.");return}if(window.confirm(`This will delete all details for ${i.length} employee(s) permanently. Are you sure?`))try{const a=await y.put("/company/cards/bulk-delete",{ids:i});a.data.success?(l.success(a.data.message),_.reload({only:["cards"]}),typeof refreshTable=="function"&&refreshTable()):l.error(a.data.message||"Failed to delete selected employees.")}catch(a){console.error(a),l.error(a.response?.data?.message||"An error occurred while deleting selected employees.")}};c.useEffect(()=>{(async()=>{const a=await te();b(a),console.log("Cards",d)})()},[]),c.useEffect(()=>{k("Employees Management"),w("")},[]);const S=(a,r,s)=>{const t=document.createElement("div");return setTimeout(()=>{B.createRoot(t).render(e.jsxs(R,{children:[e.jsx(f,{onClick:()=>window.location.href=`/company/cards/${s.id}/edit`,children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ce,{className:"h-4 w-4"})," ",e.jsx("span",{children:"Edit"})]})}),e.jsx(f,{onClick:()=>A(s.id),children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(oe,{className:"h-4 w-4"})," ",e.jsx("span",{children:"Delete"})]})}),e.jsx(f,{onClick:()=>C(s.id,s.status),children:s.status==="active"?"Set Inactive":"Set Active"})]}))},0),t},N=(a,r,s)=>{const t=document.createElement("div");return setTimeout(()=>{B.createRoot(t).render(e.jsxs("div",{className:"flex gap-1 items-center flex-wrap",children:[e.jsx(re,{eligibility:s?.is_eligible_for_sync?.eligible}),s.is_syncing&&Number(s.is_syncing)===1?e.jsx(ue,{}):e.jsx(ne,{status:s?.wallet_status?.status})]}))},0),t},C=async(a,r)=>{const s=r==="active"?"inactive":"active";if(confirm(`Are you sure you want to set this card as ${s}?`))try{const t=await y.put(`/cards/${a}/toggle-status`,{status:s});t.data?.success?(l.success(t.data.message||"Card status updated successfully."),_.reload({only:["cards"]}),typeof refreshTable=="function"&&refreshTable()):l.error(t.data?.message||"Failed to update card status.")}catch(t){if(t.response&&t.response.data){const n=t.response.data;n.message?l.error(n.message):n.errors?Object.values(n.errors).forEach(p=>{l.error(p)}):l.error("An unexpected error occurred.")}else l.error("Network error or server is unreachable.")}},[U,pe]=c.useState(!1),[D,E]=c.useState(!1),[q,I]=c.useState(!1),[i,P]=c.useState([]),z=c.useMemo(()=>[{title:'<input type="checkbox" id="select-all" /> ID',data:"id",orderable:!1,render:(a,r,s)=>{const t=i.includes(s.id);return`
        <div class="flex items-center gap-2">
            <input type="checkbox" 
                   class="row-checkbox" 
                   value="${s.id}" 
                   ${t?"checked":""} />
            <span>${s.id}</span>
        </div>
    `}},{title:"Code",data:"code",render:(a,r,s)=>`<a href="${u}/card/${a}" target="_blank" class="text-[#50bd5b] underline">${a}</a>`},{title:"User",data:null,render:(a,r,s)=>{const n=[s.salutation,s.title,s.first_name,s.last_name].filter(Boolean).join(" ");return`
                    <div class="flex items-center gap-2">
                        <img
                            src="${s.profile_image?`/storage/${s.profile_image}`:"/assets/images/profile-placeholder.png"}"
                            alt="Profile"
                            class="rounded-full border-2 bg-white border-white w-8 h-8 object-cover shrink-0"
                        />
                        <div class="space-y0.5">
                            <p class="font-medium text-[#181D27] text-sm">
                                ${n||"Not assigned"}
                            </p>
                            ${s.primary_email?`<p class="text-xs">${s.primary_email}</p>`:""}
                        </div>
                    </div>
                `}},{title:"Position",data:"position"},{title:"Department",data:"department"},{title:"Notified",data:null,render:(a,r,s)=>{const t=s.last_email_sent?new Date(s.last_email_sent):null,n=o=>o<10?`0${o}`:`${o}`,p=o=>`${n(o.getDate())}.${n(o.getMonth()+1)}.${o.getFullYear()}`,x=o=>{let m=o.getHours();const G=n(o.getMinutes()),K=m>=12?"PM":"AM";return m=m%12,m===0&&(m=12),`${m}:${G} ${K}`};if(t){const o=p(t),m=x(t);return`
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700 border border-green-200">
                                    Sent
                                </span>
                                <div class="flex flex-col leading-tight text-xs">
                                    <span>${o}</span>
                                    <span>${m}</span>
                                </div>
                            </div>
                        `}return`
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700 border border-red-200">
                                Never
                            </span>
                        </div>
                    `}},{title:"Status",data:"status",render:a=>{const r=a==="active";return`<span class="px-2 py-1 text-xs font-medium rounded-full ${r?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200"}">
                    ${r?"Active":"Inactive"}
                </span>`}},{title:"Wallet Status",data:null,render:N},{title:"Actions",data:null,orderable:!1,searchable:!1,render:S}],[u]);c.useEffect(()=>{const a=document.getElementById("select-all");if(!a)return;const r=t=>{const n=t.target.checked,p=document.querySelectorAll(".row-checkbox"),x=[];p.forEach(o=>{o.checked=n,n&&x.push(parseInt(o.value))}),P(n?x:[]),I(n)},s=()=>{const t=document.querySelectorAll(".row-checkbox"),n=Array.from(document.querySelectorAll(".row-checkbox:checked")),p=n.map(x=>parseInt(x.value));a.checked=n.length===t.length,P(p),I(p.length>0)};return a.addEventListener("change",r),document.addEventListener("change",t=>{t.target.classList.contains("row-checkbox")&&s()}),()=>{a.removeEventListener("change",r)}},[u]);const[Y,L]=c.useState(!1),V=async()=>{if(!i.length){l.error("Please select at least one employee.");return}L(!0);try{const a=await y.post("/cards/download",{selected_ids:i,csv_fields:ae.map(n=>n.name)},{responseType:"blob"}),r=new Blob([a.data],{type:"text/csv;charset=utf-8;"}),s=window.URL.createObjectURL(r),t=document.createElement("a");t.href=s,t.download="base_sample.csv",t.click(),window.URL.revokeObjectURL(s)}catch(a){console.error("CSV download failed:",a)}finally{L(!1)}},[$,M]=c.useState(!1),W=async a=>{if(!i.length){l.error("Please select at least one employee.");return}M(!0);try{const r=await y.post("/cards/toggle-multiple-status",{ids:i,status:a});l.success(r.data.message),_.reload({only:["cards"]}),typeof refreshTable=="function"&&refreshTable()}catch(r){console.error("Toggle failed:",r);const s=r.response?.data?.message||"Failed to update status.";l.error(s)}finally{M(!1)}},[T,me]=c.useState([]);return console.log("Cards: ",d),c.useEffect(()=>{if(!d||d.length===0){E(!1);return}const a=d.map(t=>({id:t.id,is_syncing:Number(t.is_syncing)}));let r=!1;if(window.prevEmployeesSyncStatus){for(let t=0;t<a.length;t++)if(a[t].is_syncing!==window.prevEmployeesSyncStatus[t]?.is_syncing){r=!0;break}}else r=!0;window.prevEmployeesSyncStatus=a;const s=a.some(t=>t.is_syncing===1);E(s),r&&typeof refreshTable=="function"&&refreshTable()},[d]),console.log("backendErrors: ",T),e.jsxs(ee,{children:[e.jsx(Z,{title:"Cards"}),e.jsx(de,{isSyncingBg:D,setIsSyncingBg:E,employees:d,setEmployees:v}),e.jsx("div",{className:"py-4 md:px-6 px-4 flex flex-col gap-6",children:h?e.jsx("div",{className:"space-y-5",children:e.jsxs("div",{className:"py-4 md:px-6 px-4 rounded-[14px] bg-white flex flex-col gap-3 space-y-3",children:[e.jsxs("div",{className:"relative mb-2",children:[e.jsx("div",{className:"flex items-center gap-3 flex-wrap",children:e.jsxs(R,{align:"left",button:e.jsxs("div",{className:"flex items-center py-[9px] gap-2 cursor-pointer px-4 rounded-md border border-gray-500 text-sm",children:[e.jsx("span",{children:"Bulk actions"}),e.jsx(le,{className:"h-5 w-5"})]}),children:[e.jsx(f,{onClick:()=>W("active"),disabled:!i.length||$,children:"Set Active"}),e.jsx(f,{onClick:()=>W("inactive"),disabled:!i.length||$,children:"Set Inactive"}),e.jsx(f,{onClick:()=>j(),disabled:!i.length||$,children:"Delete Multiple"}),e.jsx(f,{onClick:V,disabled:!q,children:Y?"Saving...":"Download Base CSV"})]})}),i.length>0?e.jsxs("p",{className:"text-sm text-primary top-full left-0 absolute mt-1",children:[i.length," card(s) selected"]}):null]}),Object.keys(T).length>0&&e.jsxs("div",{className:"bg-red-50 border-l-4 border-red-400 text-red-700 p-4 mb-2",children:[e.jsx("p",{className:"font-bold",children:"Some cards could not be synced, fix the issues first then try again."}),e.jsx("ul",{className:"mt-2 list-disc list-inside text-sm",children:Object.entries(T).map(([a,r])=>r.map((s,t)=>e.jsxs("li",{children:["Card #",a,":"," ",s.message]},`${a}-${t}`)))})]}),e.jsx(F,{isSyncing:U}),e.jsx(F,{isSyncing:D,syncType:"background"}),e.jsx(H,{data:d,columns:z,className:"display site-datatable",options:{responsive:!0,pageLength:10,lengthMenu:[10,25,50,100],dom:"<'flex justify-between items-center mb-3 sd-top'<'flex items-center gap-2'l><'flex items-center gap-2'f>>rt<'flex justify-center mt-3 sd-bottom'p>"}},u)]})}):e.jsx("div",{className:"p-4 bg-red-100 text-red-700 rounded-md",children:"You can only access this page with a valid subscription. Contact Admin for more information."})})]})}export{Ne as default};
