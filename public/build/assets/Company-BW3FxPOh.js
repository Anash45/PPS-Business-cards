import{r as c,b as f,j as e,u as se,a as te,H as ae,z as l,d as N,D as U}from"./app-BdG4lEph.js";import{A as re}from"./AuthenticatedLayout-CnV6hi5z.js";import{E as J,D as ne}from"./dataTables.dataTables-Bf27UsjQ.js";import{D as q,a as p}from"./DropdownUi-DJmwXGaZ.js";import{g as le}from"./viteConfig-gEqUb4HH.js";import{c as ce}from"./csvFieldDefinitions-TqO1r_F2.js";import{L as oe,S as I,W as ie,a as de}from"./SyncingWarning-7YKayDbS.js";import{C as ue}from"./chevron-down-D8ybw1Nd.js";import{S as me}from"./square-pen-rPMnu7y5.js";import{T as pe}from"./trash-2-CYGTJ3II.js";import"./ApplicationLogo-BywIuilN.js";function ge({employees:k,setEmployees:w,isSyncingBg:g}){const[E,y]=c.useState(null);return c.useEffect(()=>{if(!g){E&&(clearInterval(E),y(null));return}const b=setInterval(async()=>{try{const d=await f.get("/company/cards/sync-status"),{synced_employees:v}=d.data;v&&v.length&&w(h=>h.map(j=>{const C=v.find(_=>_.id===j.id);return C?{...j,is_syncing:0,wallet_status:C.wallet_status}:j})),k.every(h=>Number(h.is_syncing)===0)&&(clearInterval(b),y(null))}catch(d){console.error("Error checking employee sync status:",d)}},30*1e3);return y(b),()=>clearInterval(b)},[g,k,w]),null}function fe(){return e.jsxs("span",{role:"status","aria-live":"polite",className:"inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 ring-1 ring-blue-200",title:"Syncing",children:[e.jsx(oe,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"Syncing"})]})}J.use(ne);function Ne(){const{cards:k,isSubscriptionActive:w,hasRunningJob:g,hasRunningEmailJob:E}=se().props,{setHeaderTitle:y,setHeaderText:b}=te(),[d,v]=c.useState("https://app.ppsbusinesscards.de"),[S,h]=c.useState(k),j=async a=>{if(window.confirm("This will delete all card details and related data permanently. Are you sure?"))try{const t=await f.put(`/company/cards/${a}/delete`);t.data.success?(l.success(t.data.message),N.reload({only:["cards"]}),typeof refreshTable=="function"&&refreshTable()):l.error(t.data.message||"Failed to delete card.")}catch(t){console.error(t),l.error(t.response?.data?.message||"An error occurred while deleting the card.")}},C=async()=>{if(!o||o.length===0){l.error("Please select at least one employee.");return}if(window.confirm(`This will delete all details for ${o.length} employee(s) permanently. Are you sure?`))try{const a=await f.put("/company/cards/bulk-delete",{ids:o});a.data.success?(l.success(a.data.message),N.reload({only:["cards"]}),typeof refreshTable=="function"&&refreshTable()):l.error(a.data.message||"Failed to delete selected employees.")}catch(a){console.error(a),l.error(a.response?.data?.message||"An error occurred while deleting selected employees.")}};c.useEffect(()=>{(async()=>{const a=await le();v(a),console.log("Cards",S)})()},[]),c.useEffect(()=>{y("Employees Management"),b("")},[]);const _=(a,t,s)=>{const r=document.createElement("div");return setTimeout(()=>{U.createRoot(r).render(e.jsxs(q,{children:[e.jsx(p,{onClick:()=>window.location.href=`/company/cards/${s.id}/edit`,children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(me,{className:"h-4 w-4"})," ",e.jsx("span",{children:"Edit"})]})}),e.jsx(p,{onClick:()=>j(s.id),children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(pe,{className:"h-4 w-4"})," ",e.jsx("span",{children:"Delete"})]})}),e.jsx(p,{onClick:()=>V(s.id,s.status),children:s.status==="active"?"Set Inactive":"Set Active"})]}))},0),r},z=(a,t,s)=>{const r=document.createElement("div");return setTimeout(()=>{U.createRoot(r).render(e.jsxs("div",{className:"flex gap-1 items-center flex-wrap",children:[e.jsx(ie,{eligibility:s?.is_eligible_for_sync?.eligible}),s.is_syncing&&Number(s.is_syncing)===1?e.jsx(fe,{}):e.jsx(de,{status:s?.wallet_status?.status})]}))},0),r},V=async(a,t)=>{const s=t==="active"?"inactive":"active";if(confirm(`Are you sure you want to set this card as ${s}?`))try{const r=await f.put(`/cards/${a}/toggle-status`,{status:s});r.data?.success?(l.success(r.data.message||"Card status updated successfully."),N.reload({only:["cards"]}),typeof refreshTable=="function"&&refreshTable()):l.error(r.data?.message||"Failed to update card status.")}catch(r){if(r.response&&r.response.data){const n=r.response.data;n.message?l.error(n.message):n.errors?Object.values(n.errors).forEach(u=>{l.error(u)}):l.error("An unexpected error occurred.")}else l.error("Network error or server is unreachable.")}},[Y,he]=c.useState(!1),[P,L]=c.useState(g??!1),[R,A]=c.useState(E??!1),[M,B]=c.useState(!1),[o,$]=c.useState([]),G=c.useMemo(()=>[{title:'<input type="checkbox" id="select-all" /> ID',data:"id",render:(a,t,s)=>{const r=o.includes(s.id);return`
        <label class="flex items-center gap-2">
            <input type="checkbox" 
                   class="row-checkbox" 
                   value="${s.id}" 
                   ${r?"checked":""} />
            <span>${s.id}</span>
        </label>
    `}},{title:"Code",data:"code",render:(a,t,s)=>`<a href="${d}/card/${a}" target="_blank" class="text-[#50bd5b] underline">${a}</a>`},{title:"User",data:null,render:(a,t,s)=>{const n=[s.salutation,s.title,s.first_name,s.last_name].filter(Boolean).join(" ");return`
                    <div class="flex items-center gap-2">
                        <img
                            src="${s.profile_image?`/storage/${s.profile_image}`:"/assets/images/profile-placeholder.png"}"
                            alt="Profile"
                            class="rounded-full border-2 bg-white border-white w-8 h-8 object-cover shrink-0"
                        />
                        <div class="space-y0.5">
                            <p class="font-medium text-[#181D27] text-sm">
                                ${n||"Not assigned"}
                            </p>
                            ${s.primary_email?`<p class="text-xs">${s.primary_email}</p>`:""}
                        </div>
                    </div>
                `}},{title:"Position",data:"position"},{title:"Department",data:"department"},{title:"Notified",data:null,render:(a,t,s)=>{const r=s.last_email_sent?new Date(s.last_email_sent):null,n=i=>i<10?`0${i}`:`${i}`,u=i=>`${n(i.getDate())}.${n(i.getMonth()+1)}.${i.getFullYear()}`,x=i=>{let m=i.getHours();const Z=n(i.getMinutes()),ee=m>=12?"PM":"AM";return m=m%12,m===0&&(m=12),`${m}:${Z} ${ee}`};if(r){const i=u(r),m=x(r);return`
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700 border border-green-200">
                                    Sent
                                </span>
                                <div class="flex flex-col leading-tight text-xs">
                                    <span>${i}</span>
                                    <span>${m}</span>
                                </div>
                            </div>
                        `}return`
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700 border border-red-200">
                                Never
                            </span>
                        </div>
                    `}},{title:"Status",data:"status",render:a=>{const t=a==="active";return`<span class="px-2 py-1 text-xs font-medium rounded-full ${t?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200"}">
                    ${t?"Active":"Inactive"}
                </span>`}},{title:"Wallet Status",data:null,render:z},{title:"Actions",data:null,orderable:!1,searchable:!1,render:_}],[d]);c.useEffect(()=>{const a=document.getElementById("select-all");if(!a)return;const t=r=>{const n=r.target.checked,u=document.querySelectorAll(".row-checkbox"),x=[];u.forEach(i=>{i.checked=n,n&&x.push(parseInt(i.value))}),$(n?x:[]),B(n)},s=()=>{const r=document.querySelectorAll(".row-checkbox"),n=Array.from(document.querySelectorAll(".row-checkbox:checked")),u=n.map(x=>parseInt(x.value));a.checked=n.length===r.length,$(u),B(u.length>0)};return a.addEventListener("change",t),document.addEventListener("change",r=>{r.target.classList.contains("row-checkbox")&&s()}),()=>{a.removeEventListener("change",t)}},[d]);const[K,F]=c.useState(!1),Q=async()=>{if(!o.length){l.error("Please select at least one employee.");return}F(!0);try{const a=await f.post("/cards/download",{selected_ids:o,csv_fields:ce.map(n=>n.name)},{responseType:"blob"}),t=new Blob([a.data],{type:"text/csv;charset=utf-8;"}),s=window.URL.createObjectURL(t),r=document.createElement("a");r.href=s,r.download="base_sample.csv",r.click(),window.URL.revokeObjectURL(s)}catch(a){console.error("CSV download failed:",a)}finally{F(!1)}},[T,W]=c.useState(!1),O=async a=>{if(!o.length){l.error("Please select at least one employee.");return}W(!0);try{const t=await f.post("/cards/toggle-multiple-status",{ids:o,status:a});l.success(t.data.message),N.reload({only:["cards"]}),typeof refreshTable=="function"&&refreshTable()}catch(t){console.error("Toggle failed:",t);const s=t.response?.data?.message||"Failed to update status.";l.error(s)}finally{W(!1)}},[D,H]=c.useState([]),X=async()=>{if(!o.length){l.error("Please select at least one employee.");return}A(!0),H([]);let a=[...S];try{const t=await f.post("/company/cards/card-sending-emails",{ids:o});t.data?.success?(l.success(t.data.message||"Emails sending in background!"),$([])):(l.error(t.data.message||"Failed to schedule background email sending."),h(a),A(!1))}catch(t){console.error("Background email sending schedule failed:",t),A(!1),$([]),t.response?.status===422&&t.response.data.errors?H(t.response.data.errors):l.error(t.response?.data?.message||"Failed to schedule background email sending.")}};return console.log("hasRunningJob: ",g),c.useEffect(()=>{L(g)},[g]),console.log("backendErrors: ",D),e.jsxs(re,{children:[e.jsx(ae,{title:"Cards"}),e.jsx(ge,{isSyncingBg:P,setIsSyncingBg:L,employees:S,setEmployees:h}),e.jsx("div",{className:"py-4 md:px-6 px-4 flex flex-col gap-6",children:w?e.jsx("div",{className:"space-y-5",children:e.jsxs("div",{className:"py-4 md:px-6 px-4 rounded-[14px] bg-white flex flex-col gap-3 space-y-3",children:[e.jsxs("div",{className:"relative mb-2",children:[e.jsx("div",{className:"flex items-center gap-3 flex-wrap",children:e.jsxs(q,{align:"left",button:e.jsxs("div",{className:"flex items-center py-[9px] gap-2 cursor-pointer px-4 rounded-md border border-gray-500 text-sm",children:[e.jsx("span",{children:"Bulk actions"}),e.jsx(ue,{className:"h-5 w-5"})]}),children:[e.jsx(p,{onClick:()=>O("active"),disabled:!o.length||T,children:"Set Active"}),e.jsx(p,{onClick:()=>O("inactive"),disabled:!o.length||T,children:"Set Inactive"}),e.jsx(p,{onClick:()=>C(),disabled:!o.length||T,children:"Delete Multiple"}),e.jsx(p,{onClick:Q,disabled:!M,children:K?"Saving...":"Download Base CSV"}),e.jsx(p,{onClick:X,closeOnClick:!0,disabled:!M,children:R?"Sending E-mails...":"Send E-mails"})]})}),o.length>0?e.jsxs("p",{className:"text-sm text-primary top-full left-0 absolute mt-1",children:[o.length," card(s) selected"]}):null]}),Object.keys(D).length>0&&e.jsxs("div",{className:"bg-red-50 border-l-4 border-red-400 text-red-700 p-4 mb-2",children:[e.jsx("p",{className:"font-bold",children:"Some cards could not be synced, fix the issues first then try again."}),e.jsx("ul",{className:"mt-2 list-disc list-inside text-sm",children:Object.entries(D).map(([a,t])=>t.map((s,r)=>e.jsxs("li",{children:["Card #",a,":"," ",s.message]},`${a}-${r}`)))})]}),e.jsx(I,{isSyncing:Y}),e.jsx(I,{isSyncing:P,syncType:"background"}),e.jsx(I,{isSyncing:R,syncType:"emailSending"}),e.jsx(J,{data:S,columns:G,className:"display site-datatable",options:{responsive:!0,pageLength:10,lengthMenu:[10,25,50,100],dom:"<'flex justify-between items-center mb-3 sd-top'<'flex items-center gap-2'l><'flex items-center gap-2'f>>rt<'flex justify-center mt-3 sd-bottom'p>"}},d)]})}):e.jsx("div",{className:"p-4 bg-red-100 text-red-700 rounded-md",children:"You can only access this page with a valid subscription. Contact Admin for more information."})})]})}export{Ne as default};
