import{c as K,j as e,r as o,b as m,u as J,a as Q,H as X,z as n,d as E,D as R}from"./app-D68qQHw_.js";import{A as Z}from"./AuthenticatedLayout-Cj6qVVJj.js";import{E as U,D as ee}from"./dataTables.dataTables-BgeLmKCZ.js";import{D as F,a as p}from"./DropdownUi-BlZAF7Lh.js";import{g as se}from"./viteConfig-gEqUb4HH.js";import{c as te}from"./csvFieldDefinitions-TqO1r_F2.js";import{W as ae,a as re}from"./WalletEligibilityPill-Bjfuplso.js";import{C as ne}from"./chevron-down-DDa391Bm.js";import{S as le}from"./square-pen-f3aVKLVx.js";import{T as ce}from"./trash-2-B6ISMjS_.js";import"./ApplicationLogo-CkV8i2t9.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],q=K("loader-circle",oe);function O({isSyncing:f,syncType:g="normal"}){return f?e.jsxs("div",{className:"bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700 p-4 mb-2 flex items-start gap-3",children:[e.jsx(q,{className:"h-5 w-5 animate-spin flex-shrink-0 mt-1"}),g=="background"?e.jsxs("div",{children:[e.jsx("p",{className:"font-bold",children:"Card Wallets syncing..."}),e.jsx("p",{className:"mt-1 text-sm",children:"⚠️ Syncing in background. You can keep doing your work."})]}):e.jsxs("div",{children:[e.jsx("p",{className:"font-bold",children:"Card Wallets syncing..."}),e.jsx("p",{className:"mt-1 text-sm",children:"⚠️ Keep the page open until it finishes. It may take some time."})]})]}):null}function ie({employees:f,setEmployees:g,isSyncingBg:j}){const[k,d]=o.useState(null);return o.useEffect(()=>{if(!j){k&&(clearInterval(k),d(null));return}const x=setInterval(async()=>{try{const i=await m.get("/company/cards/sync-status"),{synced_employees:u}=i.data;u&&u.length&&g(b=>b.map(v=>{const S=u.find(N=>N.id===v.id);return S?{...v,is_syncing:0,wallet_status:S.wallet_status}:v})),f.every(b=>Number(b.is_syncing)===0)&&(clearInterval(x),d(null))}catch(i){console.error("Error checking employee sync status:",i)}},30*1e3);return d(x),()=>clearInterval(x)},[j,f,g]),null}function de(){return e.jsxs("span",{role:"status","aria-live":"polite",className:"inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 ring-1 ring-blue-200",title:"Syncing",children:[e.jsx(q,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"Syncing"})]})}U.use(ee);function Se(){const{cards:f,isSubscriptionActive:g}=J().props,{setHeaderTitle:j,setHeaderText:k}=Q(),[d,x]=o.useState("https://app.ppsbusinesscards.de"),[i,u]=o.useState(f),I=async s=>{if(window.confirm("This will delete all card details and related data permanently. Are you sure?"))try{const a=await m.put(`/company/cards/${s}/delete`);a.data.success?(n.success(a.data.message),E.reload({only:["cards"]}),typeof refreshTable=="function"&&refreshTable()):n.error(a.data.message||"Failed to delete card.")}catch(a){console.error(a),n.error(a.response?.data?.message||"An error occurred while deleting the card.")}},b=async()=>{if(!c||c.length===0){n.error("Please select at least one employee.");return}if(window.confirm(`This will delete all details for ${c.length} employee(s) permanently. Are you sure?`))try{const s=await m.put("/company/cards/bulk-delete",{ids:c});s.data.success?(n.success(s.data.message),E.reload({only:["cards"]}),typeof refreshTable=="function"&&refreshTable()):n.error(s.data.message||"Failed to delete selected employees.")}catch(s){console.error(s),n.error(s.response?.data?.message||"An error occurred while deleting selected employees.")}};o.useEffect(()=>{(async()=>{const s=await se();x(s),console.log("Cards",i)})()},[]),o.useEffect(()=>{j("Employees Management"),k("")},[]);const v=(s,a,r)=>{const t=document.createElement("div");return setTimeout(()=>{R.createRoot(t).render(e.jsxs(F,{children:[e.jsx(p,{onClick:()=>window.location.href=`/company/cards/${r.id}/edit`,children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(le,{className:"h-4 w-4"})," ",e.jsx("span",{children:"Edit"})]})}),e.jsx(p,{onClick:()=>I(r.id),children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ce,{className:"h-4 w-4"})," ",e.jsx("span",{children:"Delete"})]})}),e.jsx(p,{onClick:()=>N(r.id,r.status),children:r.status==="active"?"Set Inactive":"Set Active"})]}))},0),t},S=(s,a,r)=>{const t=document.createElement("div");return setTimeout(()=>{R.createRoot(t).render(e.jsxs("div",{className:"flex gap-1 items-center flex-wrap",children:[e.jsx(ae,{eligibility:r?.is_eligible_for_sync?.eligible}),r.is_syncing&&Number(r.is_syncing)===1?e.jsx(de,{}):e.jsx(re,{status:r?.wallet_status?.status})]}))},0),t},N=async(s,a)=>{const r=a==="active"?"inactive":"active";if(confirm(`Are you sure you want to set this card as ${r}?`))try{const t=await m.put(`/cards/${s}/toggle-status`,{status:r});t.data?.success?(n.success(t.data.message||"Card status updated successfully."),E.reload({only:["cards"]}),typeof refreshTable=="function"&&refreshTable()):n.error(t.data?.message||"Failed to update card status.")}catch(t){if(t.response&&t.response.data){const l=t.response.data;l.message?n.error(l.message):l.errors?Object.values(l.errors).forEach(y=>{n.error(y)}):n.error("An unexpected error occurred.")}else n.error("Network error or server is unreachable.")}},[H,ue]=o.useState(!1),[_,h]=o.useState(!1),[D,$]=o.useState(!1),[c,w]=o.useState([]),z=o.useMemo(()=>[{title:'<input type="checkbox" id="select-all" /> ID',data:"id",orderable:!1,render:(s,a,r)=>{const t=c.includes(r.id);return`
        <div class="flex items-center gap-2">
            <input type="checkbox" 
                   class="row-checkbox" 
                   value="${r.id}" 
                   ${t?"checked":""} />
            <span>${r.id}</span>
        </div>
    `}},{title:"Code",data:"code",render:(s,a,r)=>`<a href="${d}/card/${s}" target="_blank" class="text-[#50bd5b] underline">${s}</a>`},{title:"User",data:null,render:(s,a,r)=>{const l=[r.salutation,r.title,r.first_name,r.last_name].filter(Boolean).join(" ");return`
                    <div class="flex items-center gap-2">
                        <img
                            src="${r.profile_image?`/storage/${r.profile_image}`:"/assets/images/profile-placeholder.png"}"
                            alt="Profile"
                            class="rounded-full border-2 bg-white border-white w-8 h-8 object-cover shrink-0"
                        />
                        <div class="space-y0.5">
                            <p class="font-medium text-[#181D27] text-sm">
                                ${l||"Not assigned"}
                            </p>
                            ${r.primary_email?`<p class="text-xs">${r.primary_email}</p>`:""}
                        </div>
                    </div>
                `}},{title:"Position",data:"position"},{title:"Department",data:"department"},{title:"Status",data:"status",render:s=>{const a=s==="active";return`<span class="px-2 py-1 text-xs font-medium rounded-full ${a?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200"}">
                    ${a?"Active":"Inactive"}
                </span>`}},{title:"Wallet Status",data:null,render:S},{title:"Actions",data:null,orderable:!1,searchable:!1,render:v}],[d]);o.useEffect(()=>{const s=document.getElementById("select-all");if(!s)return;const a=t=>{const l=t.target.checked,y=document.querySelectorAll(".row-checkbox"),C=[];y.forEach(M=>{M.checked=l,l&&C.push(parseInt(M.value))}),w(l?C:[]),$(l)},r=()=>{const t=document.querySelectorAll(".row-checkbox"),l=Array.from(document.querySelectorAll(".row-checkbox:checked")),y=l.map(C=>parseInt(C.value));s.checked=l.length===t.length,w(y),$(y.length>0)};return s.addEventListener("change",a),document.addEventListener("change",t=>{t.target.classList.contains("row-checkbox")&&r()}),()=>{s.removeEventListener("change",a)}},[d]);const[V,P]=o.useState(!1),Y=async()=>{if(!c.length){n.error("Please select at least one employee.");return}P(!0);try{const s=await m.post("/cards/download",{selected_ids:c,csv_fields:te.map(l=>l.name)},{responseType:"blob"}),a=new Blob([s.data],{type:"text/csv;charset=utf-8;"}),r=window.URL.createObjectURL(a),t=document.createElement("a");t.href=r,t.download="base_sample.csv",t.click(),window.URL.revokeObjectURL(r)}catch(s){console.error("CSV download failed:",s)}finally{P(!1)}},[T,L]=o.useState(!1),B=async s=>{if(!c.length){n.error("Please select at least one employee.");return}L(!0);try{const a=await m.post("/cards/toggle-multiple-status",{ids:c,status:s});n.success(a.data.message),E.reload({only:["cards"]}),typeof refreshTable=="function"&&refreshTable()}catch(a){console.error("Toggle failed:",a);const r=a.response?.data?.message||"Failed to update status.";n.error(r)}finally{L(!1)}},[A,W]=o.useState([]),G=async()=>{if(!c.length){n.error("Please select at least one employee.");return}h(!0),W([]);let s=[...i];try{u(r=>r.map(t=>c.includes(t.id)&&t.is_syncing!==1?{...t,is_syncing:1}:t));const a=await m.post("/company/cards/sync-multiple-wallets-background",{ids:c});a.data?.success?(n.success(a.data.message||"Employees syncing in background!"),w([])):(n.error(a.data.message||"Failed to schedule background sync."),u(s),h(!1))}catch(a){console.error("Background sync schedule failed:",a),u(s),h(!1),w([]),a.response?.status===422&&a.response.data.errors?W(a.response.data.errors):n.error(a.response?.data?.message||"Failed to schedule background sync.")}};return console.log("Cards: ",i),o.useEffect(()=>{if(!i||i.length===0){h(!1);return}const s=i.map(t=>({id:t.id,is_syncing:Number(t.is_syncing)}));let a=!1;if(window.prevEmployeesSyncStatus){for(let t=0;t<s.length;t++)if(s[t].is_syncing!==window.prevEmployeesSyncStatus[t]?.is_syncing){a=!0;break}}else a=!0;window.prevEmployeesSyncStatus=s;const r=s.some(t=>t.is_syncing===1);h(r),a&&typeof refreshTable=="function"&&refreshTable()},[i]),console.log("backendErrors: ",A),e.jsxs(Z,{children:[e.jsx(X,{title:"Cards"}),e.jsx(ie,{isSyncingBg:_,setIsSyncingBg:h,employees:i,setEmployees:u}),e.jsx("div",{className:"py-4 md:px-6 px-4 flex flex-col gap-6",children:g?e.jsx("div",{className:"space-y-5",children:e.jsxs("div",{className:"py-4 md:px-6 px-4 rounded-[14px] bg-white flex flex-col gap-3 space-y-3",children:[e.jsxs("div",{className:"relative mb-2",children:[e.jsx("div",{className:"flex items-center gap-3 flex-wrap",children:e.jsxs(F,{align:"left",button:e.jsxs("div",{className:"flex items-center py-[9px] gap-2 cursor-pointer px-4 rounded-md border border-gray-500 text-sm",children:[e.jsx("span",{children:"Bulk actions"}),e.jsx(ne,{className:"h-5 w-5"})]}),children:[e.jsx(p,{onClick:()=>B("active"),disabled:!c.length||T,children:"Set Active"}),e.jsx(p,{onClick:()=>B("inactive"),disabled:!c.length||T,children:"Set Inactive"}),e.jsx(p,{onClick:()=>b(),disabled:!c.length||T,children:"Delete Multiple"}),e.jsx(p,{onClick:Y,disabled:!D,children:V?"Saving...":"Download Base CSV"}),e.jsx(p,{onClick:G,closeOnClick:!0,disabled:!D,children:_?"Syncing...":"Sync wallet passes"})]})}),c.length>0?e.jsxs("p",{className:"text-sm text-primary top-full left-0 absolute mt-1",children:[c.length," card(s) selected"]}):null]}),Object.keys(A).length>0&&e.jsxs("div",{className:"bg-red-50 border-l-4 border-red-400 text-red-700 p-4 mb-2",children:[e.jsx("p",{className:"font-bold",children:"Some cards could not be synced, fix the issues first then try again."}),e.jsx("ul",{className:"mt-2 list-disc list-inside text-sm",children:Object.entries(A).map(([s,a])=>a.map((r,t)=>e.jsxs("li",{children:["Card #",s,":"," ",r.message]},`${s}-${t}`)))})]}),e.jsx(O,{isSyncing:H}),e.jsx(O,{isSyncing:_,syncType:"background"}),e.jsx(U,{data:i,columns:z,className:"display site-datatable",options:{responsive:!0,pageLength:10,lengthMenu:[10,25,50,100],dom:"<'flex justify-between items-center mb-3 sd-top'<'flex items-center gap-2'l><'flex items-center gap-2'f>>rt<'flex justify-center mt-3 sd-bottom'p>"}},d)]})}):e.jsx("div",{className:"p-4 bg-red-100 text-red-700 rounded-md",children:"You can only access this page with a valid subscription. Contact Admin for more information."})})]})}export{Se as default};
