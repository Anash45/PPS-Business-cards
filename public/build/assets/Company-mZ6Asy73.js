import{r as o,b as g,j as e,u as se,a as te,H as ae,z as l,d as A,D as J}from"./app-179TCp1B.js";import{A as re}from"./AuthenticatedLayout-BuM6ZAsi.js";import{E as q,D as ne}from"./dataTables.dataTables-C5jxiVw2.js";import{D as U,a as b}from"./DropdownUi-zhP-dXbo.js";import{g as le}from"./viteConfig-gEqUb4HH.js";import{c as ce}from"./csvFieldDefinitions-TqO1r_F2.js";import{L as oe,S as L,W as ie,a as de}from"./SyncingWarning-BQx3X3IF.js";import{C as ue}from"./chevron-down-Bk8uoSrp.js";import{S as me}from"./square-pen-BUCF0s-E.js";import{T as pe}from"./trash-2-1zJXhKmO.js";import"./ApplicationLogo-DzhX5DEj.js";function fe({employees:m,setEmployees:p,isSyncingBg:n}){const[u,f]=o.useState(null);return o.useEffect(()=>{if(!n){u&&(clearInterval(u),f(null));return}const S=setInterval(async()=>{try{const h=await g.get("/company/cards/sync-status"),{synced_employees:k}=h.data;k&&k.length&&p(v=>v.map(E=>{const C=k.find(T=>T.id===E.id);return C?{...E,is_syncing:0,wallet_status:C.wallet_status}:E})),m.every(v=>Number(v.is_syncing)===0)&&(clearInterval(S),f(null))}catch(h){console.error("Error checking employee sync status:",h)}},30*1e3);return f(S),()=>clearInterval(S)},[n,m,p]),null}function ge(){return e.jsxs("span",{role:"status","aria-live":"polite",className:"inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 ring-1 ring-blue-200",title:"Syncing",children:[e.jsx(oe,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"Syncing"})]})}function he(m,p){const n=o.useRef(null);o.useEffect(()=>{if(!m){n.current&&(clearInterval(n.current),n.current=null);return}return n.current=setInterval(async()=>{try{const u=await g.get("/wallet-jobs/status"),{hasRunningJob:f}=u.data;f||(p(!1),clearInterval(n.current),n.current=null)}catch(u){console.error("Error checking wallet job status:",u)}},5e3),()=>{n.current&&clearInterval(n.current)}},[m,p])}function xe(m,p){const n=o.useRef(null);o.useEffect(()=>{if(!m){n.current&&(clearInterval(n.current),n.current=null);return}return n.current=setInterval(async()=>{try{const u=await g.get("/email-jobs/status"),{hasRunningJob:f}=u.data;f||(p(!1),clearInterval(n.current),n.current=null)}catch(u){console.error("Error checking email job status:",u)}},5e3),()=>{n.current&&clearInterval(n.current)}},[m,p])}q.use(ne);function _e(){const{cards:m,isSubscriptionActive:p,hasRunningJob:n,hasRunningEmailJob:u}=se().props,{setHeaderTitle:f,setHeaderText:S}=te(),[h,k]=o.useState("https://app.ppsbusinesscards.de"),[w,v]=o.useState(m),E=async s=>{if(window.confirm("This will delete all card details and related data permanently. Are you sure?"))try{const a=await g.put(`/company/cards/${s}/delete`);a.data.success?(l.success(a.data.message),A.reload({only:["cards"]}),typeof refreshTable=="function"&&refreshTable()):l.error(a.data.message||"Failed to delete card.")}catch(a){console.error(a),l.error(a.response?.data?.message||"An error occurred while deleting the card.")}},C=async()=>{if(!i||i.length===0){l.error("Please select at least one employee.");return}if(window.confirm(`This will delete all details for ${i.length} employee(s) permanently. Are you sure?`))try{const s=await g.put("/company/cards/bulk-delete",{ids:i});s.data.success?(l.success(s.data.message),A.reload({only:["cards"]}),typeof refreshTable=="function"&&refreshTable()):l.error(s.data.message||"Failed to delete selected employees.")}catch(s){console.error(s),l.error(s.response?.data?.message||"An error occurred while deleting selected employees.")}};o.useEffect(()=>{(async()=>{const s=await le();k(s),console.log("Cards",w)})()},[]),o.useEffect(()=>{f("Employees Management"),S("")},[]);const T=(s,a,t)=>{const r=document.createElement("div");return setTimeout(()=>{J.createRoot(r).render(e.jsxs(U,{children:[e.jsx(b,{onClick:()=>window.location.href=`/company/cards/${t.id}/edit`,children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(me,{className:"h-4 w-4"})," ",e.jsx("span",{children:"Edit"})]})}),e.jsx(b,{onClick:()=>E(t.id),children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(pe,{className:"h-4 w-4"})," ",e.jsx("span",{children:"Delete"})]})}),e.jsx(b,{onClick:()=>V(t.id,t.status),children:t.status==="active"?"Set Inactive":"Set Active"})]}))},0),r},z=(s,a,t)=>{const r=document.createElement("div");return setTimeout(()=>{J.createRoot(r).render(e.jsxs("div",{className:"flex gap-1 items-center flex-wrap",children:[e.jsx(ie,{eligibility:t?.is_eligible_for_sync?.eligible}),t.is_syncing&&Number(t.is_syncing)===1?e.jsx(ge,{}):e.jsx(de,{status:t?.wallet_status?.status})]}))},0),r},V=async(s,a)=>{const t=a==="active"?"inactive":"active";if(confirm(`Are you sure you want to set this card as ${t}?`))try{const r=await g.put(`/cards/${s}/toggle-status`,{status:t});r.data?.success?(l.success(r.data.message||"Card status updated successfully."),A.reload({only:["cards"]}),typeof refreshTable=="function"&&refreshTable()):l.error(r.data?.message||"Failed to update card status.")}catch(r){if(r.response&&r.response.data){const c=r.response.data;c.message?l.error(c.message):c.errors?Object.values(c.errors).forEach(x=>{l.error(x)}):l.error("An unexpected error occurred.")}else l.error("Network error or server is unreachable.")}},[Y,ye]=o.useState(!1),[$,D]=o.useState(n??!1),[N,I]=o.useState(u??!1),[M,W]=o.useState(!1),[i,_]=o.useState([]);he($,s=>{!s&&$&&(D(!1),l.success("Wallet sync completed!"))}),xe(N,s=>{!s&&N&&(I(!1),l.success("Email sending completed!"))});const G=o.useMemo(()=>[{title:'<input type="checkbox" id="select-all" /> ID',data:"id",render:(s,a,t)=>{const r=i.includes(t.id);return`
        <label class="flex items-center gap-2">
            <input type="checkbox" 
                   class="row-checkbox" 
                   value="${t.id}" 
                   ${r?"checked":""} />
            <span>${t.id}</span>
        </label>
    `}},{title:"Code",data:"code",render:(s,a,t)=>`<a href="${h}/card/${s}" target="_blank" class="text-[#50bd5b] underline">${s}</a>`},{title:"User",data:null,render:(s,a,t)=>{const c=[t.salutation,t.title,t.first_name,t.last_name].filter(Boolean).join(" ");return`
                    <div class="flex items-center gap-2">
                        <img
                            src="${t.profile_image?`/storage/${t.profile_image}`:"/assets/images/profile-placeholder.png"}"
                            alt="Profile"
                            class="rounded-full border-2 bg-white border-white w-8 h-8 object-cover shrink-0"
                        />
                        <div class="space-y0.5">
                            <p class="font-medium text-[#181D27] text-sm">
                                ${c||"Not assigned"}
                            </p>
                            ${t.primary_email?`<p class="text-xs">${t.primary_email}</p>`:""}
                        </div>
                    </div>
                `}},{title:"Position",data:"position"},{title:"Department",data:"department"},{title:"Notified",data:null,render:(s,a,t)=>{const r=t.last_email_sent?new Date(t.last_email_sent):null,c=d=>d<10?`0${d}`:`${d}`,x=d=>`${c(d.getDate())}.${c(d.getMonth()+1)}.${d.getFullYear()}`,j=d=>{let y=d.getHours();const Z=c(d.getMinutes()),ee=y>=12?"PM":"AM";return y=y%12,y===0&&(y=12),`${y}:${Z} ${ee}`};if(r){const d=x(r),y=j(r);return`
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700 border border-green-200">
                                    Sent
                                </span>
                                <div class="flex flex-col leading-tight text-xs">
                                    <span>${d}</span>
                                    <span>${y}</span>
                                </div>
                            </div>
                        `}return`
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700 border border-red-200">
                                Never
                            </span>
                        </div>
                    `}},{title:"Status",data:"status",render:s=>{const a=s==="active";return`<span class="px-2 py-1 text-xs font-medium rounded-full ${a?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200"}">
                    ${a?"Active":"Inactive"}
                </span>`}},{title:"Wallet Status",data:null,render:z},{title:"Actions",data:null,orderable:!1,searchable:!1,render:T}],[h]);o.useEffect(()=>{const s=document.getElementById("select-all");if(!s)return;const a=r=>{const c=r.target.checked,x=document.querySelectorAll(".row-checkbox"),j=[];x.forEach(d=>{d.checked=c,c&&j.push(parseInt(d.value))}),_(c?j:[]),W(c)},t=()=>{const r=document.querySelectorAll(".row-checkbox"),c=Array.from(document.querySelectorAll(".row-checkbox:checked")),x=c.map(j=>parseInt(j.value));s.checked=c.length===r.length,_(x),W(x.length>0)};return s.addEventListener("change",a),document.addEventListener("change",r=>{r.target.classList.contains("row-checkbox")&&t()}),()=>{s.removeEventListener("change",a)}},[h]);const[K,F]=o.useState(!1),Q=async()=>{if(!i.length){l.error("Please select at least one employee.");return}F(!0);try{const s=await g.post("/cards/download",{selected_ids:i,csv_fields:ce.map(c=>c.name)},{responseType:"blob"}),a=new Blob([s.data],{type:"text/csv;charset=utf-8;"}),t=window.URL.createObjectURL(a),r=document.createElement("a");r.href=t,r.download="base_sample.csv",r.click(),window.URL.revokeObjectURL(t)}catch(s){console.error("CSV download failed:",s)}finally{F(!1)}},[R,B]=o.useState(!1),O=async s=>{if(!i.length){l.error("Please select at least one employee.");return}B(!0);try{const a=await g.post("/cards/toggle-multiple-status",{ids:i,status:s});l.success(a.data.message),A.reload({only:["cards"]}),typeof refreshTable=="function"&&refreshTable()}catch(a){console.error("Toggle failed:",a);const t=a.response?.data?.message||"Failed to update status.";l.error(t)}finally{B(!1)}},[P,H]=o.useState([]),X=async()=>{if(!i.length){l.error("Please select at least one employee.");return}I(!0),H([]);let s=[...w];try{const a=await g.post("/company/cards/card-sending-emails",{ids:i});a.data?.success?(l.success(a.data.message||"Emails sending in background!"),_([])):(l.error(a.data.message||"Failed to schedule background email sending."),v(s),I(!1))}catch(a){console.error("Background email sending schedule failed:",a),I(!1),_([]),a.response?.status===422&&a.response.data.errors?H(a.response.data.errors):l.error(a.response?.data?.message||"Failed to schedule background email sending.")}};return console.log("hasRunningJob: ",n),o.useEffect(()=>{D(n)},[n]),console.log("backendErrors: ",P),e.jsxs(re,{children:[e.jsx(ae,{title:"Cards"}),e.jsx(fe,{isSyncingBg:$,setIsSyncingBg:D,employees:w,setEmployees:v}),e.jsx("div",{className:"py-4 md:px-6 px-4 flex flex-col gap-6",children:p?e.jsx("div",{className:"space-y-5",children:e.jsxs("div",{className:"py-4 md:px-6 px-4 rounded-[14px] bg-white flex flex-col gap-3 space-y-3",children:[e.jsxs("div",{className:"relative mb-2",children:[e.jsx("div",{className:"flex items-center gap-3 flex-wrap",children:e.jsxs(U,{align:"left",button:e.jsxs("div",{className:"flex items-center py-[9px] gap-2 cursor-pointer px-4 rounded-md border border-gray-500 text-sm",children:[e.jsx("span",{children:"Bulk actions"}),e.jsx(ue,{className:"h-5 w-5"})]}),children:[e.jsx(b,{onClick:()=>O("active"),disabled:!i.length||R,children:"Set Active"}),e.jsx(b,{onClick:()=>O("inactive"),disabled:!i.length||R,children:"Set Inactive"}),e.jsx(b,{onClick:()=>C(),disabled:!i.length||R,children:"Delete Multiple"}),e.jsx(b,{onClick:Q,disabled:!M,children:K?"Saving...":"Download Base CSV"}),e.jsx(b,{onClick:X,closeOnClick:!0,disabled:!M,children:N?"Sending E-mails...":"Send E-mails"})]})}),i.length>0?e.jsxs("p",{className:"text-sm text-primary top-full left-0 absolute mt-1",children:[i.length," card(s) selected"]}):null]}),Object.keys(P).length>0&&e.jsxs("div",{className:"bg-red-50 border-l-4 border-red-400 text-red-700 p-4 mb-2",children:[e.jsx("p",{className:"font-bold",children:"Some cards could not be synced, fix the issues first then try again."}),e.jsx("ul",{className:"mt-2 list-disc list-inside text-sm",children:Object.entries(P).map(([s,a])=>a.map((t,r)=>e.jsxs("li",{children:["Card #",s,":"," ",t.message]},`${s}-${r}`)))})]}),e.jsx(L,{isSyncing:Y}),e.jsx(L,{isSyncing:$,syncType:"background"}),e.jsx(L,{isSyncing:N,syncType:"emailSending"}),e.jsx(q,{data:w,columns:G,className:"display site-datatable",options:{responsive:!0,pageLength:10,lengthMenu:[10,25,50,100],dom:"<'flex justify-between items-center mb-3 sd-top'<'flex items-center gap-2'l><'flex items-center gap-2'f>>rt<'flex justify-center mt-3 sd-bottom'p>"}},h)]})}):e.jsx("div",{className:"p-4 bg-red-100 text-red-700 rounded-md",children:"You can only access this page with a valid subscription. Contact Admin for more information."})})]})}export{_e as default};
