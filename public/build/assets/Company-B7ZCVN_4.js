import{c as X,j as e,r as o,b as h,u as Z,a as ee,H as se,z as l,d as E,D as R}from"./app-BV87h2Bw.js";import{A as te}from"./AuthenticatedLayout-DfdWQjiV.js";import{E as U,D as ae}from"./dataTables.dataTables-Drcj2WKE.js";import{D as O,a as g}from"./DropdownUi-D_BEoxEh.js";import{g as re}from"./viteConfig-gEqUb4HH.js";import{c as ne}from"./csvFieldDefinitions-TqO1r_F2.js";import{W as le,a as ce}from"./WalletEligibilityPill-DAsETyJ2.js";import{C as oe}from"./chevron-down-ByIPMHPK.js";import{S as ie}from"./square-pen-1fznKStD.js";import{T as de}from"./trash-2-DRc36BJQ.js";import"./ApplicationLogo-CQU7Kxbf.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],q=X("loader-circle",ue);function H({isSyncing:y,syncType:x="normal"}){return y?e.jsxs("div",{className:"bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700 p-4 mb-2 flex items-start gap-3",children:[e.jsx(q,{className:"h-5 w-5 animate-spin flex-shrink-0 mt-1"}),x=="background"?e.jsxs("div",{children:[e.jsx("p",{className:"font-bold",children:"Card Wallets syncing..."}),e.jsx("p",{className:"mt-1 text-sm",children:"⚠️ Syncing in background. You can keep doing your work."})]}):e.jsxs("div",{children:[e.jsx("p",{className:"font-bold",children:"Card Wallets syncing..."}),e.jsx("p",{className:"mt-1 text-sm",children:"⚠️ Keep the page open until it finishes. It may take some time."})]})]}):null}function pe({employees:y,setEmployees:x,isSyncingBg:w}){const[N,u]=o.useState(null);return o.useEffect(()=>{if(!w){N&&(clearInterval(N),u(null));return}const j=setInterval(async()=>{try{const d=await h.get("/company/cards/sync-status"),{synced_employees:p}=d.data;p&&p.length&&x(S=>S.map(k=>{const _=p.find($=>$.id===k.id);return _?{...k,is_syncing:0,wallet_status:_.wallet_status}:k})),y.every(S=>Number(S.is_syncing)===0)&&(clearInterval(j),u(null))}catch(d){console.error("Error checking employee sync status:",d)}},30*1e3);return u(j),()=>clearInterval(j)},[w,y,x]),null}function me(){return e.jsxs("span",{role:"status","aria-live":"polite",className:"inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 ring-1 ring-blue-200",title:"Syncing",children:[e.jsx(q,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{children:"Syncing"})]})}U.use(ae);function _e(){const{cards:y,isSubscriptionActive:x}=Z().props,{setHeaderTitle:w,setHeaderText:N}=ee(),[u,j]=o.useState("https://app.ppsbusinesscards.de"),[d,p]=o.useState(y),I=async t=>{if(window.confirm("This will delete all card details and related data permanently. Are you sure?"))try{const r=await h.put(`/company/cards/${t}/delete`);r.data.success?(l.success(r.data.message),E.reload({only:["cards"]}),typeof refreshTable=="function"&&refreshTable()):l.error(r.data.message||"Failed to delete card.")}catch(r){console.error(r),l.error(r.response?.data?.message||"An error occurred while deleting the card.")}},S=async()=>{if(!c||c.length===0){l.error("Please select at least one employee.");return}if(window.confirm(`This will delete all details for ${c.length} employee(s) permanently. Are you sure?`))try{const t=await h.put("/company/cards/bulk-delete",{ids:c});t.data.success?(l.success(t.data.message),E.reload({only:["cards"]}),typeof refreshTable=="function"&&refreshTable()):l.error(t.data.message||"Failed to delete selected employees.")}catch(t){console.error(t),l.error(t.response?.data?.message||"An error occurred while deleting selected employees.")}};o.useEffect(()=>{(async()=>{const t=await re();j(t),console.log("Cards",d)})()},[]),o.useEffect(()=>{w("Employees Management"),N("")},[]);const k=(t,r,a)=>{const s=document.createElement("div");return setTimeout(()=>{R.createRoot(s).render(e.jsxs(O,{children:[e.jsx(g,{onClick:()=>window.location.href=`/company/cards/${a.id}/edit`,children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ie,{className:"h-4 w-4"})," ",e.jsx("span",{children:"Edit"})]})}),e.jsx(g,{onClick:()=>I(a.id),children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(de,{className:"h-4 w-4"})," ",e.jsx("span",{children:"Delete"})]})}),e.jsx(g,{onClick:()=>$(a.id,a.status),children:a.status==="active"?"Set Inactive":"Set Active"})]}))},0),s},_=(t,r,a)=>{const s=document.createElement("div");return setTimeout(()=>{R.createRoot(s).render(e.jsxs("div",{className:"flex gap-1 items-center flex-wrap",children:[e.jsx(le,{eligibility:a?.is_eligible_for_sync?.eligible}),a.is_syncing&&Number(a.is_syncing)===1?e.jsx(me,{}):e.jsx(ce,{status:a?.wallet_status?.status})]}))},0),s},$=async(t,r)=>{const a=r==="active"?"inactive":"active";if(confirm(`Are you sure you want to set this card as ${a}?`))try{const s=await h.put(`/cards/${t}/toggle-status`,{status:a});s.data?.success?(l.success(s.data.message||"Card status updated successfully."),E.reload({only:["cards"]}),typeof refreshTable=="function"&&refreshTable()):l.error(s.data?.message||"Failed to update card status.")}catch(s){if(s.response&&s.response.data){const n=s.response.data;n.message?l.error(n.message):n.errors?Object.values(n.errors).forEach(m=>{l.error(m)}):l.error("An unexpected error occurred.")}else l.error("Network error or server is unreachable.")}},[z,fe]=o.useState(!1),[T,b]=o.useState(!1),[P,L]=o.useState(!1),[c,C]=o.useState([]),Y=o.useMemo(()=>[{title:'<input type="checkbox" id="select-all" /> ID',data:"id",render:(t,r,a)=>{const s=c.includes(a.id);return`
        <label class="flex items-center gap-2">
            <input type="checkbox" 
                   class="row-checkbox" 
                   value="${a.id}" 
                   ${s?"checked":""} />
            <span>${a.id}</span>
        </label>
    `}},{title:"Code",data:"code",render:(t,r,a)=>`<a href="${u}/card/${t}" target="_blank" class="text-[#50bd5b] underline">${t}</a>`},{title:"User",data:null,render:(t,r,a)=>{const n=[a.salutation,a.title,a.first_name,a.last_name].filter(Boolean).join(" ");return`
                    <div class="flex items-center gap-2">
                        <img
                            src="${a.profile_image?`/storage/${a.profile_image}`:"/assets/images/profile-placeholder.png"}"
                            alt="Profile"
                            class="rounded-full border-2 bg-white border-white w-8 h-8 object-cover shrink-0"
                        />
                        <div class="space-y0.5">
                            <p class="font-medium text-[#181D27] text-sm">
                                ${n||"Not assigned"}
                            </p>
                            ${a.primary_email?`<p class="text-xs">${a.primary_email}</p>`:""}
                        </div>
                    </div>
                `}},{title:"Position",data:"position"},{title:"Department",data:"department"},{title:"Notified",data:null,render:(t,r,a)=>{const s=a.last_email_sent?new Date(a.last_email_sent):null,n=i=>i<10?`0${i}`:`${i}`,m=i=>`${n(i.getDate())}.${n(i.getMonth()+1)}.${i.getFullYear()}`,v=i=>{let f=i.getHours();const J=n(i.getMinutes()),Q=f>=12?"PM":"AM";return f=f%12,f===0&&(f=12),`${f}:${J} ${Q}`};if(s){const i=m(s),f=v(s);return`
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700 border border-green-200">
                                    Sent
                                </span>
                                <div class="flex flex-col leading-tight text-xs">
                                    <span>${i}</span>
                                    <span>${f}</span>
                                </div>
                            </div>
                        `}return`
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700 border border-red-200">
                                Never
                            </span>
                        </div>
                    `}},{title:"Status",data:"status",render:t=>{const r=t==="active";return`<span class="px-2 py-1 text-xs font-medium rounded-full ${r?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200"}">
                    ${r?"Active":"Inactive"}
                </span>`}},{title:"Wallet Status",data:null,render:_},{title:"Actions",data:null,orderable:!1,searchable:!1,render:k}],[u]);o.useEffect(()=>{const t=document.getElementById("select-all");if(!t)return;const r=s=>{const n=s.target.checked,m=document.querySelectorAll(".row-checkbox"),v=[];m.forEach(i=>{i.checked=n,n&&v.push(parseInt(i.value))}),C(n?v:[]),L(n)},a=()=>{const s=document.querySelectorAll(".row-checkbox"),n=Array.from(document.querySelectorAll(".row-checkbox:checked")),m=n.map(v=>parseInt(v.value));t.checked=n.length===s.length,C(m),L(m.length>0)};return t.addEventListener("change",r),document.addEventListener("change",s=>{s.target.classList.contains("row-checkbox")&&a()}),()=>{t.removeEventListener("change",r)}},[u]);const[V,M]=o.useState(!1),G=async()=>{if(!c.length){l.error("Please select at least one employee.");return}M(!0);try{const t=await h.post("/cards/download",{selected_ids:c,csv_fields:ne.map(n=>n.name)},{responseType:"blob"}),r=new Blob([t.data],{type:"text/csv;charset=utf-8;"}),a=window.URL.createObjectURL(r),s=document.createElement("a");s.href=a,s.download="base_sample.csv",s.click(),window.URL.revokeObjectURL(a)}catch(t){console.error("CSV download failed:",t)}finally{M(!1)}},[A,B]=o.useState(!1),W=async t=>{if(!c.length){l.error("Please select at least one employee.");return}B(!0);try{const r=await h.post("/cards/toggle-multiple-status",{ids:c,status:t});l.success(r.data.message),E.reload({only:["cards"]}),typeof refreshTable=="function"&&refreshTable()}catch(r){console.error("Toggle failed:",r);const a=r.response?.data?.message||"Failed to update status.";l.error(a)}finally{B(!1)}},[D,F]=o.useState([]),K=async()=>{if(!c.length){l.error("Please select at least one employee.");return}b(!0),F([]);let t=[...d];try{p(a=>a.map(s=>c.includes(s.id)&&s.is_syncing!==1?{...s,is_syncing:1}:s));const r=await h.post("/company/cards/sync-multiple-wallets-background",{ids:c});r.data?.success?(l.success(r.data.message||"Employees syncing in background!"),C([])):(l.error(r.data.message||"Failed to schedule background sync."),p(t),b(!1))}catch(r){console.error("Background sync schedule failed:",r),p(t),b(!1),C([]),r.response?.status===422&&r.response.data.errors?F(r.response.data.errors):l.error(r.response?.data?.message||"Failed to schedule background sync.")}};return console.log("Cards: ",d),o.useEffect(()=>{if(!d||d.length===0){b(!1);return}const t=d.map(s=>({id:s.id,is_syncing:Number(s.is_syncing)}));let r=!1;if(window.prevEmployeesSyncStatus){for(let s=0;s<t.length;s++)if(t[s].is_syncing!==window.prevEmployeesSyncStatus[s]?.is_syncing){r=!0;break}}else r=!0;window.prevEmployeesSyncStatus=t;const a=t.some(s=>s.is_syncing===1);b(a),r&&typeof refreshTable=="function"&&refreshTable()},[d]),console.log("backendErrors: ",D),e.jsxs(te,{children:[e.jsx(se,{title:"Cards"}),e.jsx(pe,{isSyncingBg:T,setIsSyncingBg:b,employees:d,setEmployees:p}),e.jsx("div",{className:"py-4 md:px-6 px-4 flex flex-col gap-6",children:x?e.jsx("div",{className:"space-y-5",children:e.jsxs("div",{className:"py-4 md:px-6 px-4 rounded-[14px] bg-white flex flex-col gap-3 space-y-3",children:[e.jsxs("div",{className:"relative mb-2",children:[e.jsx("div",{className:"flex items-center gap-3 flex-wrap",children:e.jsxs(O,{align:"left",button:e.jsxs("div",{className:"flex items-center py-[9px] gap-2 cursor-pointer px-4 rounded-md border border-gray-500 text-sm",children:[e.jsx("span",{children:"Bulk actions"}),e.jsx(oe,{className:"h-5 w-5"})]}),children:[e.jsx(g,{onClick:()=>W("active"),disabled:!c.length||A,children:"Set Active"}),e.jsx(g,{onClick:()=>W("inactive"),disabled:!c.length||A,children:"Set Inactive"}),e.jsx(g,{onClick:()=>S(),disabled:!c.length||A,children:"Delete Multiple"}),e.jsx(g,{onClick:G,disabled:!P,children:V?"Saving...":"Download Base CSV"}),e.jsx(g,{onClick:K,closeOnClick:!0,disabled:!P,children:T?"Syncing...":"Sync wallet passes"})]})}),c.length>0?e.jsxs("p",{className:"text-sm text-primary top-full left-0 absolute mt-1",children:[c.length," card(s) selected"]}):null]}),Object.keys(D).length>0&&e.jsxs("div",{className:"bg-red-50 border-l-4 border-red-400 text-red-700 p-4 mb-2",children:[e.jsx("p",{className:"font-bold",children:"Some cards could not be synced, fix the issues first then try again."}),e.jsx("ul",{className:"mt-2 list-disc list-inside text-sm",children:Object.entries(D).map(([t,r])=>r.map((a,s)=>e.jsxs("li",{children:["Card #",t,":"," ",a.message]},`${t}-${s}`)))})]}),e.jsx(H,{isSyncing:z}),e.jsx(H,{isSyncing:T,syncType:"background"}),e.jsx(U,{data:d,columns:Y,className:"display site-datatable",options:{responsive:!0,pageLength:10,lengthMenu:[10,25,50,100],dom:"<'flex justify-between items-center mb-3 sd-top'<'flex items-center gap-2'l><'flex items-center gap-2'f>>rt<'flex justify-center mt-3 sd-bottom'p>"}},u)]})}):e.jsx("div",{className:"p-4 bg-red-100 text-red-700 rounded-md",children:"You can only access this page with a valid subscription. Contact Admin for more information."})})]})}export{_e as default};
